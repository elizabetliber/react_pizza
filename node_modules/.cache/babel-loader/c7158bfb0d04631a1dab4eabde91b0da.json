{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer,\n    crypto = require('crypto'),\n    util = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base = require('./base'),\n    Frame = require('./hybi/frame'),\n    Message = require('./hybi/message');\n\nvar Hybi = function (request, url, options) {\n  Base.apply(this, arguments);\n  this._extensions = new Extensions();\n  this._stage = 0;\n  this._masking = this._options.masking;\n  this._protocols = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks = {};\n  if (typeof this._protocols === 'string') this._protocols = this._protocols.split(/ *, */);\n  if (!this._request) return;\n  var protos = this._request.headers['sec-websocket-protocol'],\n      supported = this._protocols;\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function (p) {\n      return supported.indexOf(p) >= 0;\n    })[0];\n  }\n\n  this.version = 'hybi-' + Hybi.VERSION;\n};\n\nutil.inherits(Hybi, Base);\nHybi.VERSION = '13';\n\nHybi.mask = function (payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n\n  return payload;\n};\n\nHybi.generateAccept = function (key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\nvar instance = {\n  FIN: 0x80,\n  MASK: 0x80,\n  RSV1: 0x40,\n  RSV2: 0x20,\n  RSV3: 0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n  OPCODES: {\n    continuation: 0,\n    text: 1,\n    binary: 2,\n    close: 8,\n    ping: 9,\n    pong: 10\n  },\n  OPCODE_CODES: [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n  ERRORS: {\n    normal_closure: 1000,\n    going_away: 1001,\n    protocol_error: 1002,\n    unacceptable: 1003,\n    encoding_error: 1007,\n    policy_violation: 1008,\n    too_large: 1009,\n    extension_error: 1010,\n    unexpected_condition: 1011\n  },\n  ERROR_CODES: [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n  addExtension: function (extension) {\n    this._extensions.add(extension);\n\n    return true;\n  },\n  parse: function (chunk) {\n    this._reader.put(chunk);\n\n    var buffer = true;\n\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n\n          if (buffer) {\n            this._stage = 0;\n\n            this._emitFrame(buffer);\n          }\n\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n  text: function (message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n  binary: function (message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n  ping: function (message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n  pong: function (message) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    return this.frame(message, 'pong');\n  },\n  close: function (reason, code) {\n    reason = reason || '';\n    code = code || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n\n      this._extensions.close(function () {\n        this.frame(reason, 'close', code);\n      }, this);\n\n      return true;\n    } else {\n      return false;\n    }\n  },\n  frame: function (buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n    if (buffer instanceof Array) buffer = Buffer.from(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n    var message = new Message(),\n        isText = typeof buffer === 'string',\n        payload,\n        copy;\n    message.rsv1 = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n    payload = isText ? Buffer.from(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = Buffer.allocUnsafe(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n\n    message.data = payload;\n\n    var onMessageReady = function (message) {\n      var frame = new Frame();\n      frame.final = true;\n      frame.rsv1 = message.rsv1;\n      frame.rsv2 = message.rsv2;\n      frame.rsv3 = message.rsv3;\n      frame.opcode = message.opcode;\n      frame.masked = !!this._masking;\n      frame.length = message.data.length;\n      frame.payload = message.data;\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0) this._extensions.processOutgoingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      onMessageReady.call(this, message);\n    }, this);else onMessageReady.call(this, message);\n    return true;\n  },\n  _sendFrame: function (frame) {\n    var length = frame.length,\n        header = length <= 125 ? 2 : length <= 65535 ? 4 : 10,\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = Buffer.allocUnsafe(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n    buffer[0] = (frame.final ? this.FIN : 0) | (frame.rsv1 ? this.RSV1 : 0) | (frame.rsv2 ? this.RSV2 : 0) | (frame.rsv3 ? this.RSV3 : 0) | frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n  _handshakeResponse: function () {\n    var secKey = this._request.headers['sec-websocket-key'],\n        version = this._request.headers['sec-websocket-version'];\n    if (version !== Hybi.VERSION) throw new Error('Unsupported WebSocket version: ' + version);\n    if (typeof secKey !== 'string') throw new Error('Missing handshake request header: Sec-WebSocket-Key');\n\n    this._headers.set('Upgrade', 'websocket');\n\n    this._headers.set('Connection', 'Upgrade');\n\n    this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n\n    var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n    var start = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n    return Buffer.from(headers.join('\\r\\n'), 'utf8');\n  },\n  _shutdown: function (code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n    var sendCloseFrame = this.readyState === 1;\n    this.readyState = 2;\n\n    this._extensions.close(function () {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n  _fail: function (type, message) {\n    if (this.readyState > 1) return;\n\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n  _parseOpcode: function (octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function (rsv) {\n      return (octet & rsv) === rsv;\n    });\n    var frame = this._frame = new Frame();\n    frame.final = (octet & this.FIN) === this.FIN;\n    frame.rsv1 = rsvs[0];\n    frame.rsv2 = rsvs[1];\n    frame.rsv3 = rsvs[2];\n    frame.opcode = octet & this.OPCODE;\n    this._stage = 1;\n    if (!this._extensions.validFrameRsv(frame)) return this._fail('protocol_error', 'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) + ', reserved2 = ' + (frame.rsv2 ? 1 : 0) + ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0) return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final) return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0) return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n  _parseLength: function (octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = octet & this.LENGTH;\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = frame.length === 126 ? 2 : 8;\n    }\n\n    if (this._requireMasking && !frame.masked) return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n  _parseExtendedLength: function (buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n    this._stage = frame.masked ? 3 : 4;\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125) return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n    if (!this._checkFrameLength()) return;\n  },\n  _checkFrameLength: function () {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n\n      return false;\n    } else {\n      return true;\n    }\n  },\n  _emitFrame: function (buffer) {\n    var frame = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode = frame.opcode,\n        message,\n        code,\n        reason,\n        callbacks,\n        callback;\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0) return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code = payload.length >= 2 ? payload.readUInt16BE(0) : null;\n      reason = payload.length > 2 ? this._encode(payload.slice(2)) : null;\n      if (!(payload.length === 0) && !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) && this.ERROR_CODES.indexOf(code) < 0) code = this.ERRORS.protocol_error;\n      if (payload.length > 125 || payload.length > 2 && !reason) code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n      this.emit('ping', new Base.PingEvent(payload.toString()));\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message = this._encode(payload);\n      callback = callbacks[message];\n      delete callbacks[message];\n      if (callback) callback();\n      this.emit('pong', new Base.PongEvent(payload.toString()));\n    }\n  },\n  _emitMessage: function (message) {\n    var message = this._message;\n    message.read();\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n      if (payload === null) return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');else this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n  _encode: function (buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n  _readUInt: function (buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n    return buffer.readUInt32BE(0) * 0x100000000 + buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance) Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/websocket-driver/lib/websocket/driver/hybi.js"],"names":["Buffer","require","crypto","util","Extensions","Base","Frame","Message","Hybi","request","url","options","apply","arguments","_extensions","_stage","_masking","_options","masking","_protocols","protocols","_requireMasking","requireMasking","_pingCallbacks","split","_request","protos","headers","supported","undefined","protocol","filter","p","indexOf","version","VERSION","inherits","mask","payload","offset","length","i","n","generateAccept","key","sha1","createHash","update","GUID","digest","instance","FIN","MASK","RSV1","RSV2","RSV3","OPCODE","LENGTH","OPCODES","continuation","text","binary","close","ping","pong","OPCODE_CODES","MESSAGE_OPCODES","OPENING_OPCODES","ERRORS","normal_closure","going_away","protocol_error","unacceptable","encoding_error","policy_violation","too_large","extension_error","unexpected_condition","ERROR_CODES","DEFAULT_ERROR_CODE","MIN_RESERVED_ERROR","MAX_RESERVED_ERROR","UTF8_MATCH","addExtension","extension","add","parse","chunk","_reader","put","buffer","read","_parseOpcode","_parseLength","_frame","lengthBytes","_parseExtendedLength","maskingKey","_emitFrame","message","readyState","frame","callback","reason","code","emit","CloseEvent","type","_queue","Array","from","toString","isText","copy","rsv1","rsv2","rsv3","opcode","allocUnsafe","writeUInt16BE","data","onMessageReady","final","masked","randomBytes","_sendFrame","processOutgoingMessage","error","_fail","call","header","writeUInt32BE","Math","floor","_write","_handshakeResponse","secKey","Error","_headers","set","extensions","generateResponse","start","join","_shutdown","_message","sendCloseFrame","octet","rsvs","map","rsv","validFrameRsv","_checkFrameLength","_readUInt","_maxLength","callbacks","pushFrame","_emitMessage","readUInt16BE","_encode","slice","PingEvent","PongEvent","processIncomingMessage","MessageEvent","string","test","e","readUInt32BE","prototype","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar Buffer     = require('safe-buffer').Buffer,\n    crypto     = require('crypto'),\n    util       = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base       = require('./base'),\n    Frame      = require('./hybi/frame'),\n    Message    = require('./hybi/message');\n\nvar Hybi = function(request, url, options) {\n  Base.apply(this, arguments);\n\n  this._extensions     = new Extensions();\n  this._stage          = 0;\n  this._masking        = this._options.masking;\n  this._protocols      = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks  = {};\n\n  if (typeof this._protocols === 'string')\n    this._protocols = this._protocols.split(/ *, */);\n\n  if (!this._request) return;\n\n  var protos    = this._request.headers['sec-websocket-protocol'],\n      supported = this._protocols;\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function(p) { return supported.indexOf(p) >= 0 })[0];\n  }\n\n  this.version = 'hybi-' + Hybi.VERSION;\n};\nutil.inherits(Hybi, Base);\n\nHybi.VERSION = '13';\n\nHybi.mask = function(payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n  return payload;\n};\n\nHybi.generateAccept = function(key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n\nvar instance = {\n  FIN:    0x80,\n  MASK:   0x80,\n  RSV1:   0x40,\n  RSV2:   0x20,\n  RSV3:   0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n\n  OPCODES: {\n    continuation: 0,\n    text:         1,\n    binary:       2,\n    close:        8,\n    ping:         9,\n    pong:         10\n  },\n\n  OPCODE_CODES:    [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n\n  ERRORS: {\n    normal_closure:       1000,\n    going_away:           1001,\n    protocol_error:       1002,\n    unacceptable:         1003,\n    encoding_error:       1007,\n    policy_violation:     1008,\n    too_large:            1009,\n    extension_error:      1010,\n    unexpected_condition: 1011\n  },\n\n  ERROR_CODES:        [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n\n  addExtension: function(extension) {\n    this._extensions.add(extension);\n    return true;\n  },\n\n  parse: function(chunk) {\n    this._reader.put(chunk);\n    var buffer = true;\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n          if (buffer) {\n            this._stage = 0;\n            this._emitFrame(buffer);\n          }\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n\n  text: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n\n  binary: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n\n  pong: function(message) {\n      if (this.readyState > 1) return false;\n      message = message ||'';\n      return this.frame(message, 'pong');\n  },\n\n  close: function(reason, code) {\n    reason = reason || '';\n    code   = code   || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n      this._extensions.close(function() { this.frame(reason, 'close', code) }, this);\n      return true;\n    } else {\n      return false;\n    }\n  },\n\n  frame: function(buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n\n    if (buffer instanceof Array)    buffer = Buffer.from(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n\n    var message = new Message(),\n        isText  = (typeof buffer === 'string'),\n        payload, copy;\n\n    message.rsv1   = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n\n    payload = isText ? Buffer.from(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = Buffer.allocUnsafe(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n    message.data = payload;\n\n    var onMessageReady = function(message) {\n      var frame = new Frame();\n\n      frame.final   = true;\n      frame.rsv1    = message.rsv1;\n      frame.rsv2    = message.rsv2;\n      frame.rsv3    = message.rsv3;\n      frame.opcode  = message.opcode;\n      frame.masked  = !!this._masking;\n      frame.length  = message.data.length;\n      frame.payload = message.data;\n\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0)\n      this._extensions.processOutgoingMessage(message, function(error, message) {\n        if (error) return this._fail('extension_error', error.message);\n        onMessageReady.call(this, message);\n      }, this);\n    else\n      onMessageReady.call(this, message);\n\n    return true;\n  },\n\n  _sendFrame: function(frame) {\n    var length = frame.length,\n        header = (length <= 125) ? 2 : (length <= 65535 ? 4 : 10),\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = Buffer.allocUnsafe(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n\n    buffer[0] = (frame.final ? this.FIN : 0) |\n                (frame.rsv1 ? this.RSV1 : 0) |\n                (frame.rsv2 ? this.RSV2 : 0) |\n                (frame.rsv3 ? this.RSV3 : 0) |\n                frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n\n  _handshakeResponse: function() {\n    var secKey  = this._request.headers['sec-websocket-key'],\n        version = this._request.headers['sec-websocket-version'];\n\n    if (version !== Hybi.VERSION)\n      throw new Error('Unsupported WebSocket version: ' + version);\n\n    if (typeof secKey !== 'string')\n      throw new Error('Missing handshake request header: Sec-WebSocket-Key');\n\n    this._headers.set('Upgrade', 'websocket');\n    this._headers.set('Connection', 'Upgrade');\n    this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n\n    var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n\n    return Buffer.from(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _shutdown: function(code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n\n    var sendCloseFrame = (this.readyState === 1);\n    this.readyState = 2;\n\n    this._extensions.close(function() {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n\n  _fail: function(type, message) {\n    if (this.readyState > 1) return;\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n\n  _parseOpcode: function(octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function(rsv) {\n      return (octet & rsv) === rsv;\n    });\n\n    var frame = this._frame = new Frame();\n\n    frame.final  = (octet & this.FIN) === this.FIN;\n    frame.rsv1   = rsvs[0];\n    frame.rsv2   = rsvs[1];\n    frame.rsv3   = rsvs[2];\n    frame.opcode = (octet & this.OPCODE);\n\n    this._stage = 1;\n\n    if (!this._extensions.validFrameRsv(frame))\n      return this._fail('protocol_error',\n          'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) +\n          ', reserved2 = ' + (frame.rsv2 ? 1 : 0) +\n          ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0)\n      return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final)\n      return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0)\n      return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n\n  _parseLength: function(octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = (octet & this.LENGTH);\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = (frame.length === 126 ? 2 : 8);\n    }\n\n    if (this._requireMasking && !frame.masked)\n      return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n\n  _parseExtendedLength: function(buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n\n    this._stage = frame.masked ? 3 : 4;\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125)\n      return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n\n    if (!this._checkFrameLength()) return;\n  },\n\n  _checkFrameLength: function() {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n      return false;\n    } else {\n      return true;\n    }\n  },\n\n  _emitFrame: function(buffer) {\n    var frame   = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode  = frame.opcode,\n        message,\n        code, reason,\n        callbacks, callback;\n\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0)\n      return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code   = (payload.length >= 2) ? payload.readUInt16BE(0) : null;\n      reason = (payload.length > 2) ? this._encode(payload.slice(2)) : null;\n\n      if (!(payload.length === 0) &&\n          !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) &&\n          this.ERROR_CODES.indexOf(code) < 0)\n        code = this.ERRORS.protocol_error;\n\n      if (payload.length > 125 || (payload.length > 2 && !reason))\n        code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n      this.emit('ping', new Base.PingEvent(payload.toString()))\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message   = this._encode(payload);\n      callback  = callbacks[message];\n\n      delete callbacks[message];\n      if (callback) callback()\n\n      this.emit('pong', new Base.PongEvent(payload.toString()))\n    }\n  },\n\n  _emitMessage: function(message) {\n    var message = this._message;\n    message.read();\n\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function(error, message) {\n      if (error) return this._fail('extension_error', error.message);\n\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n\n      if (payload === null)\n        return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');\n      else\n        this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n\n  _encode: function(buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n\n  _readUInt: function(buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n\n    return buffer.readUInt32BE(0) * 0x100000000 +\n           buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance)\n  Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;\n"]},"metadata":{},"sourceType":"script"}