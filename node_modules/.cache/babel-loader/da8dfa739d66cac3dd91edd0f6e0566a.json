{"ast":null,"code":"'use strict';\n\nvar parser = exports;\n\nvar transport = require('../../../spdy-transport');\n\nvar base = transport.protocol.base;\nvar utils = base.utils;\n\nvar constants = require('./constants');\n\nvar assert = require('assert');\n\nvar util = require('util');\n\nvar OffsetBuffer = require('obuf');\n\nfunction Parser(options) {\n  base.Parser.call(this, options);\n  this.isServer = options.isServer;\n  this.waiting = constants.FRAME_HEADER_SIZE;\n  this.state = 'frame-head';\n  this.pendingHeader = null;\n}\n\nutil.inherits(Parser, base.Parser);\n\nparser.create = function create(options) {\n  return new Parser(options);\n};\n\nParser.prototype.setMaxFrameSize = function setMaxFrameSize(size) {// http2-only\n};\n\nParser.prototype.setMaxHeaderListSize = function setMaxHeaderListSize(size) {// http2-only\n}; // Only for testing\n\n\nParser.prototype.skipPreface = function skipPreface() {};\n\nParser.prototype.execute = function execute(buffer, callback) {\n  if (this.state === 'frame-head') {\n    return this.onFrameHead(buffer, callback);\n  }\n\n  assert(this.state === 'frame-body' && this.pendingHeader !== null);\n  var self = this;\n  var header = this.pendingHeader;\n  this.pendingHeader = null;\n  this.onFrameBody(header, buffer, function (err, frame) {\n    if (err) {\n      return callback(err);\n    }\n\n    self.state = 'frame-head';\n    self.waiting = constants.FRAME_HEADER_SIZE;\n    self.partial = false;\n    callback(null, frame);\n  });\n};\n\nParser.prototype.executePartial = function executePartial(buffer, callback) {\n  var header = this.pendingHeader;\n\n  if (this.window) {\n    this.window.recv.update(-buffer.size);\n  } // DATA frame\n\n\n  callback(null, {\n    type: 'DATA',\n    id: header.id,\n    // Partial DATA can't be FIN\n    fin: false,\n    data: buffer.take(buffer.size)\n  });\n};\n\nParser.prototype.onFrameHead = function onFrameHead(buffer, callback) {\n  var header = {\n    control: (buffer.peekUInt8() & 0x80) === 0x80,\n    version: null,\n    type: null,\n    id: null,\n    flags: null,\n    length: null\n  };\n\n  if (header.control) {\n    header.version = buffer.readUInt16BE() & 0x7fff;\n    header.type = buffer.readUInt16BE();\n  } else {\n    header.id = buffer.readUInt32BE(0) & 0x7fffffff;\n  }\n\n  header.flags = buffer.readUInt8();\n  header.length = buffer.readUInt24BE();\n\n  if (this.version === null && header.control) {\n    // TODO(indutny): do ProtocolError here and in the rest of errors\n    if (header.version !== 2 && header.version !== 3) {\n      return callback(new Error('Unsupported SPDY version: ' + header.version));\n    }\n\n    this.setVersion(header.version);\n  }\n\n  this.state = 'frame-body';\n  this.waiting = header.length;\n  this.pendingHeader = header;\n  this.partial = !header.control;\n  callback(null, null);\n};\n\nParser.prototype.onFrameBody = function onFrameBody(header, buffer, callback) {\n  // Data frame\n  if (!header.control) {\n    // Count received bytes\n    if (this.window) {\n      this.window.recv.update(-buffer.size);\n    } // No support for compressed DATA\n\n\n    if ((header.flags & constants.flags.FLAG_COMPRESSED) !== 0) {\n      return callback(new Error('DATA compression not supported'));\n    }\n\n    if (header.id === 0) {\n      return callback(this.error(constants.error.PROTOCOL_ERROR, 'Invalid stream id for DATA'));\n    }\n\n    return callback(null, {\n      type: 'DATA',\n      id: header.id,\n      fin: (header.flags & constants.flags.FLAG_FIN) !== 0,\n      data: buffer.take(buffer.size)\n    });\n  }\n\n  if (header.type === 0x01 || header.type === 0x02) {\n    // SYN_STREAM or SYN_REPLY\n    this.onSynHeadFrame(header.type, header.flags, buffer, callback);\n  } else if (header.type === 0x03) {\n    // RST_STREAM\n    this.onRSTFrame(buffer, callback);\n  } else if (header.type === 0x04) {\n    // SETTINGS\n    this.onSettingsFrame(buffer, callback);\n  } else if (header.type === 0x05) {\n    callback(null, {\n      type: 'NOOP'\n    });\n  } else if (header.type === 0x06) {\n    // PING\n    this.onPingFrame(buffer, callback);\n  } else if (header.type === 0x07) {\n    // GOAWAY\n    this.onGoawayFrame(buffer, callback);\n  } else if (header.type === 0x08) {\n    // HEADERS\n    this.onHeaderFrames(buffer, callback);\n  } else if (header.type === 0x09) {\n    // WINDOW_UPDATE\n    this.onWindowUpdateFrame(buffer, callback);\n  } else if (header.type === 0xf000) {\n    // X-FORWARDED\n    this.onXForwardedFrame(buffer, callback);\n  } else {\n    callback(null, {\n      type: 'unknown: ' + header.type\n    });\n  }\n};\n\nParser.prototype._filterHeader = function _filterHeader(headers, name) {\n  var res = {};\n  var keys = Object.keys(headers);\n\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n\n    if (key !== name) {\n      res[key] = headers[key];\n    }\n  }\n\n  return res;\n};\n\nParser.prototype.onSynHeadFrame = function onSynHeadFrame(type, flags, body, callback) {\n  var self = this;\n  var stream = type === 0x01;\n  var offset = stream ? 10 : this.version === 2 ? 6 : 4;\n\n  if (!body.has(offset)) {\n    return callback(new Error('SynHead OOB'));\n  }\n\n  var head = body.clone(offset);\n  body.skip(offset);\n  this.parseKVs(body, function (err, headers) {\n    if (err) {\n      return callback(err);\n    }\n\n    if (stream && (!headers[':method'] || !headers[':path'])) {\n      return callback(new Error('Missing `:method` and/or `:path` header'));\n    }\n\n    var id = head.readUInt32BE() & 0x7fffffff;\n\n    if (id === 0) {\n      return callback(self.error(constants.error.PROTOCOL_ERROR, 'Invalid stream id for HEADERS'));\n    }\n\n    var associated = stream ? head.readUInt32BE() & 0x7fffffff : 0;\n    var priority = stream ? head.readUInt8() >> 5 : utils.weightToPriority(constants.DEFAULT_WEIGHT);\n    var fin = (flags & constants.flags.FLAG_FIN) !== 0;\n    var unidir = (flags & constants.flags.FLAG_UNIDIRECTIONAL) !== 0;\n    var path = headers[':path'];\n    var isPush = stream && associated !== 0;\n    var weight = utils.priorityToWeight(priority);\n    var priorityInfo = {\n      weight: weight,\n      exclusive: false,\n      parent: 0\n    };\n\n    if (!isPush) {\n      callback(null, {\n        type: 'HEADERS',\n        id: id,\n        priority: priorityInfo,\n        fin: fin,\n        writable: !unidir,\n        headers: headers,\n        path: path\n      });\n      return;\n    }\n\n    if (stream && !headers[':status']) {\n      return callback(new Error('Missing `:status` header'));\n    }\n\n    var filteredHeaders = self._filterHeader(headers, ':status');\n\n    callback(null, [{\n      type: 'PUSH_PROMISE',\n      id: associated,\n      fin: false,\n      promisedId: id,\n      headers: filteredHeaders,\n      path: path\n    }, {\n      type: 'HEADERS',\n      id: id,\n      fin: fin,\n      priority: priorityInfo,\n      writable: true,\n      path: undefined,\n      headers: {\n        ':status': headers[':status']\n      }\n    }]);\n  });\n};\n\nParser.prototype.onHeaderFrames = function onHeaderFrames(body, callback) {\n  var offset = this.version === 2 ? 6 : 4;\n\n  if (!body.has(offset)) {\n    return callback(new Error('HEADERS OOB'));\n  }\n\n  var streamId = body.readUInt32BE() & 0x7fffffff;\n\n  if (this.version === 2) {\n    body.skip(2);\n  }\n\n  this.parseKVs(body, function (err, headers) {\n    if (err) {\n      return callback(err);\n    }\n\n    callback(null, {\n      type: 'HEADERS',\n      priority: {\n        parent: 0,\n        exclusive: false,\n        weight: constants.DEFAULT_WEIGHT\n      },\n      id: streamId,\n      fin: false,\n      writable: true,\n      path: undefined,\n      headers: headers\n    });\n  });\n};\n\nParser.prototype.parseKVs = function parseKVs(buffer, callback) {\n  var self = this;\n  this.decompress.write(buffer.toChunks(), function (err, chunks) {\n    if (err) {\n      return callback(err);\n    }\n\n    var buffer = new OffsetBuffer();\n\n    for (var i = 0; i < chunks.length; i++) {\n      buffer.push(chunks[i]);\n    }\n\n    var size = self.version === 2 ? 2 : 4;\n\n    if (!buffer.has(size)) {\n      return callback(new Error('KV OOB'));\n    }\n\n    var count = self.version === 2 ? buffer.readUInt16BE() : buffer.readUInt32BE();\n    var headers = {};\n\n    function readString() {\n      if (!buffer.has(size)) {\n        return null;\n      }\n\n      var len = self.version === 2 ? buffer.readUInt16BE() : buffer.readUInt32BE();\n\n      if (!buffer.has(len)) {\n        return null;\n      }\n\n      var value = buffer.take(len);\n      return value.toString();\n    }\n\n    while (count > 0) {\n      var key = readString();\n      var value = readString();\n\n      if (key === null || value === null) {\n        return callback(new Error('Headers OOB'));\n      }\n\n      if (self.version < 3) {\n        var isInternal = /^(method|version|url|host|scheme|status)$/.test(key);\n\n        if (key === 'url') {\n          key = 'path';\n        }\n\n        if (isInternal) {\n          key = ':' + key;\n        }\n      } // Compatibility with HTTP2\n\n\n      if (key === ':status') {\n        value = value.split(/ /g, 2)[0];\n      }\n\n      count--;\n\n      if (key === ':host') {\n        key = ':authority';\n      } // Skip version, not present in HTTP2\n\n\n      if (key === ':version') {\n        continue;\n      }\n\n      value = value.split(/\\0/g);\n\n      for (var j = 0; j < value.length; j++) {\n        utils.addHeaderLine(key, value[j], headers);\n      }\n    }\n\n    callback(null, headers);\n  });\n};\n\nParser.prototype.onRSTFrame = function onRSTFrame(body, callback) {\n  if (!body.has(8)) {\n    return callback(new Error('RST OOB'));\n  }\n\n  var frame = {\n    type: 'RST',\n    id: body.readUInt32BE() & 0x7fffffff,\n    code: constants.errorByCode[body.readUInt32BE()]\n  };\n\n  if (frame.id === 0) {\n    return callback(this.error(constants.error.PROTOCOL_ERROR, 'Invalid stream id for RST'));\n  }\n\n  if (body.size !== 0) {\n    frame.extra = body.take(body.size);\n  }\n\n  callback(null, frame);\n};\n\nParser.prototype.onSettingsFrame = function onSettingsFrame(body, callback) {\n  if (!body.has(4)) {\n    return callback(new Error('SETTINGS OOB'));\n  }\n\n  var settings = {};\n  var number = body.readUInt32BE();\n  var idMap = {\n    1: 'upload_bandwidth',\n    2: 'download_bandwidth',\n    3: 'round_trip_time',\n    4: 'max_concurrent_streams',\n    5: 'current_cwnd',\n    6: 'download_retrans_rate',\n    7: 'initial_window_size',\n    8: 'client_certificate_vector_size'\n  };\n\n  if (!body.has(number * 8)) {\n    return callback(new Error('SETTINGS OOB#2'));\n  }\n\n  for (var i = 0; i < number; i++) {\n    var id = this.version === 2 ? body.readUInt32LE() : body.readUInt32BE();\n    var flags = id >> 24 & 0xff;\n    id = id & 0xffffff; // Skip persisted settings\n\n    if (flags & 0x2) {\n      continue;\n    }\n\n    var name = idMap[id];\n    settings[name] = body.readUInt32BE();\n  }\n\n  callback(null, {\n    type: 'SETTINGS',\n    settings: settings\n  });\n};\n\nParser.prototype.onPingFrame = function onPingFrame(body, callback) {\n  if (!body.has(4)) {\n    return callback(new Error('PING OOB'));\n  }\n\n  var isServer = this.isServer;\n  var opaque = body.clone(body.size).take(body.size);\n  var id = body.readUInt32BE();\n  var ack = isServer ? id % 2 === 0 : id % 2 === 1;\n  callback(null, {\n    type: 'PING',\n    opaque: opaque,\n    ack: ack\n  });\n};\n\nParser.prototype.onGoawayFrame = function onGoawayFrame(body, callback) {\n  if (!body.has(8)) {\n    return callback(new Error('GOAWAY OOB'));\n  }\n\n  callback(null, {\n    type: 'GOAWAY',\n    lastId: body.readUInt32BE() & 0x7fffffff,\n    code: constants.goawayByCode[body.readUInt32BE()]\n  });\n};\n\nParser.prototype.onWindowUpdateFrame = function onWindowUpdateFrame(body, callback) {\n  if (!body.has(8)) {\n    return callback(new Error('WINDOW_UPDATE OOB'));\n  }\n\n  callback(null, {\n    type: 'WINDOW_UPDATE',\n    id: body.readUInt32BE() & 0x7fffffff,\n    delta: body.readInt32BE()\n  });\n};\n\nParser.prototype.onXForwardedFrame = function onXForwardedFrame(body, callback) {\n  if (!body.has(4)) {\n    return callback(new Error('X_FORWARDED OOB'));\n  }\n\n  var len = body.readUInt32BE();\n\n  if (!body.has(len)) {\n    return callback(new Error('X_FORWARDED host length OOB'));\n  }\n\n  callback(null, {\n    type: 'X_FORWARDED_FOR',\n    host: body.take(len).toString()\n  });\n};","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/spdy-transport/lib/spdy-transport/protocol/spdy/parser.js"],"names":["parser","exports","transport","require","base","protocol","utils","constants","assert","util","OffsetBuffer","Parser","options","call","isServer","waiting","FRAME_HEADER_SIZE","state","pendingHeader","inherits","create","prototype","setMaxFrameSize","size","setMaxHeaderListSize","skipPreface","execute","buffer","callback","onFrameHead","self","header","onFrameBody","err","frame","partial","executePartial","window","recv","update","type","id","fin","data","take","control","peekUInt8","version","flags","length","readUInt16BE","readUInt32BE","readUInt8","readUInt24BE","Error","setVersion","FLAG_COMPRESSED","error","PROTOCOL_ERROR","FLAG_FIN","onSynHeadFrame","onRSTFrame","onSettingsFrame","onPingFrame","onGoawayFrame","onHeaderFrames","onWindowUpdateFrame","onXForwardedFrame","_filterHeader","headers","name","res","keys","Object","i","key","body","stream","offset","has","head","clone","skip","parseKVs","associated","priority","weightToPriority","DEFAULT_WEIGHT","unidir","FLAG_UNIDIRECTIONAL","path","isPush","weight","priorityToWeight","priorityInfo","exclusive","parent","writable","filteredHeaders","promisedId","undefined","streamId","decompress","write","toChunks","chunks","push","count","readString","len","value","toString","isInternal","test","split","j","addHeaderLine","code","errorByCode","extra","settings","number","idMap","readUInt32LE","opaque","ack","lastId","goawayByCode","delta","readInt32BE","host"],"mappings":"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","sourcesContent":["'use strict'\n\nvar parser = exports\n\nvar transport = require('../../../spdy-transport')\nvar base = transport.protocol.base\nvar utils = base.utils\nvar constants = require('./constants')\n\nvar assert = require('assert')\nvar util = require('util')\nvar OffsetBuffer = require('obuf')\n\nfunction Parser (options) {\n  base.Parser.call(this, options)\n\n  this.isServer = options.isServer\n  this.waiting = constants.FRAME_HEADER_SIZE\n  this.state = 'frame-head'\n  this.pendingHeader = null\n}\nutil.inherits(Parser, base.Parser)\n\nparser.create = function create (options) {\n  return new Parser(options)\n}\n\nParser.prototype.setMaxFrameSize = function setMaxFrameSize (size) {\n  // http2-only\n}\n\nParser.prototype.setMaxHeaderListSize = function setMaxHeaderListSize (size) {\n  // http2-only\n}\n\n// Only for testing\nParser.prototype.skipPreface = function skipPreface () {\n}\n\nParser.prototype.execute = function execute (buffer, callback) {\n  if (this.state === 'frame-head') { return this.onFrameHead(buffer, callback) }\n\n  assert(this.state === 'frame-body' && this.pendingHeader !== null)\n\n  var self = this\n  var header = this.pendingHeader\n  this.pendingHeader = null\n\n  this.onFrameBody(header, buffer, function (err, frame) {\n    if (err) {\n      return callback(err)\n    }\n\n    self.state = 'frame-head'\n    self.waiting = constants.FRAME_HEADER_SIZE\n    self.partial = false\n    callback(null, frame)\n  })\n}\n\nParser.prototype.executePartial = function executePartial (buffer, callback) {\n  var header = this.pendingHeader\n\n  if (this.window) {\n    this.window.recv.update(-buffer.size)\n  }\n\n  // DATA frame\n  callback(null, {\n    type: 'DATA',\n    id: header.id,\n\n    // Partial DATA can't be FIN\n    fin: false,\n    data: buffer.take(buffer.size)\n  })\n}\n\nParser.prototype.onFrameHead = function onFrameHead (buffer, callback) {\n  var header = {\n    control: (buffer.peekUInt8() & 0x80) === 0x80,\n    version: null,\n    type: null,\n    id: null,\n    flags: null,\n    length: null\n  }\n\n  if (header.control) {\n    header.version = buffer.readUInt16BE() & 0x7fff\n    header.type = buffer.readUInt16BE()\n  } else {\n    header.id = buffer.readUInt32BE(0) & 0x7fffffff\n  }\n  header.flags = buffer.readUInt8()\n  header.length = buffer.readUInt24BE()\n\n  if (this.version === null && header.control) {\n    // TODO(indutny): do ProtocolError here and in the rest of errors\n    if (header.version !== 2 && header.version !== 3) {\n      return callback(new Error('Unsupported SPDY version: ' + header.version))\n    }\n    this.setVersion(header.version)\n  }\n\n  this.state = 'frame-body'\n  this.waiting = header.length\n  this.pendingHeader = header\n  this.partial = !header.control\n\n  callback(null, null)\n}\n\nParser.prototype.onFrameBody = function onFrameBody (header, buffer, callback) {\n  // Data frame\n  if (!header.control) {\n    // Count received bytes\n    if (this.window) {\n      this.window.recv.update(-buffer.size)\n    }\n\n    // No support for compressed DATA\n    if ((header.flags & constants.flags.FLAG_COMPRESSED) !== 0) {\n      return callback(new Error('DATA compression not supported'))\n    }\n\n    if (header.id === 0) {\n      return callback(this.error(constants.error.PROTOCOL_ERROR,\n        'Invalid stream id for DATA'))\n    }\n\n    return callback(null, {\n      type: 'DATA',\n      id: header.id,\n      fin: (header.flags & constants.flags.FLAG_FIN) !== 0,\n      data: buffer.take(buffer.size)\n    })\n  }\n\n  if (header.type === 0x01 || header.type === 0x02) { // SYN_STREAM or SYN_REPLY\n    this.onSynHeadFrame(header.type, header.flags, buffer, callback)\n  } else if (header.type === 0x03) { // RST_STREAM\n    this.onRSTFrame(buffer, callback)\n  } else if (header.type === 0x04) { // SETTINGS\n    this.onSettingsFrame(buffer, callback)\n  } else if (header.type === 0x05) {\n    callback(null, { type: 'NOOP' })\n  } else if (header.type === 0x06) { // PING\n    this.onPingFrame(buffer, callback)\n  } else if (header.type === 0x07) { // GOAWAY\n    this.onGoawayFrame(buffer, callback)\n  } else if (header.type === 0x08) { // HEADERS\n    this.onHeaderFrames(buffer, callback)\n  } else if (header.type === 0x09) { // WINDOW_UPDATE\n    this.onWindowUpdateFrame(buffer, callback)\n  } else if (header.type === 0xf000) { // X-FORWARDED\n    this.onXForwardedFrame(buffer, callback)\n  } else {\n    callback(null, { type: 'unknown: ' + header.type })\n  }\n}\n\nParser.prototype._filterHeader = function _filterHeader (headers, name) {\n  var res = {}\n  var keys = Object.keys(headers)\n\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i]\n    if (key !== name) {\n      res[key] = headers[key]\n    }\n  }\n\n  return res\n}\n\nParser.prototype.onSynHeadFrame = function onSynHeadFrame (type,\n  flags,\n  body,\n  callback) {\n  var self = this\n  var stream = type === 0x01\n  var offset = stream ? 10 : this.version === 2 ? 6 : 4\n\n  if (!body.has(offset)) {\n    return callback(new Error('SynHead OOB'))\n  }\n\n  var head = body.clone(offset)\n  body.skip(offset)\n  this.parseKVs(body, function (err, headers) {\n    if (err) {\n      return callback(err)\n    }\n\n    if (stream &&\n        (!headers[':method'] || !headers[':path'])) {\n      return callback(new Error('Missing `:method` and/or `:path` header'))\n    }\n\n    var id = head.readUInt32BE() & 0x7fffffff\n\n    if (id === 0) {\n      return callback(self.error(constants.error.PROTOCOL_ERROR,\n        'Invalid stream id for HEADERS'))\n    }\n\n    var associated = stream ? head.readUInt32BE() & 0x7fffffff : 0\n    var priority = stream\n      ? head.readUInt8() >> 5\n      : utils.weightToPriority(constants.DEFAULT_WEIGHT)\n    var fin = (flags & constants.flags.FLAG_FIN) !== 0\n    var unidir = (flags & constants.flags.FLAG_UNIDIRECTIONAL) !== 0\n    var path = headers[':path']\n\n    var isPush = stream && associated !== 0\n\n    var weight = utils.priorityToWeight(priority)\n    var priorityInfo = {\n      weight: weight,\n      exclusive: false,\n      parent: 0\n    }\n\n    if (!isPush) {\n      callback(null, {\n        type: 'HEADERS',\n        id: id,\n        priority: priorityInfo,\n        fin: fin,\n        writable: !unidir,\n        headers: headers,\n        path: path\n      })\n      return\n    }\n\n    if (stream && !headers[':status']) {\n      return callback(new Error('Missing `:status` header'))\n    }\n\n    var filteredHeaders = self._filterHeader(headers, ':status')\n\n    callback(null, [ {\n      type: 'PUSH_PROMISE',\n      id: associated,\n      fin: false,\n      promisedId: id,\n      headers: filteredHeaders,\n      path: path\n    }, {\n      type: 'HEADERS',\n      id: id,\n      fin: fin,\n      priority: priorityInfo,\n      writable: true,\n      path: undefined,\n      headers: {\n        ':status': headers[':status']\n      }\n    }])\n  })\n}\n\nParser.prototype.onHeaderFrames = function onHeaderFrames (body, callback) {\n  var offset = this.version === 2 ? 6 : 4\n  if (!body.has(offset)) {\n    return callback(new Error('HEADERS OOB'))\n  }\n\n  var streamId = body.readUInt32BE() & 0x7fffffff\n  if (this.version === 2) { body.skip(2) }\n\n  this.parseKVs(body, function (err, headers) {\n    if (err) { return callback(err) }\n\n    callback(null, {\n      type: 'HEADERS',\n      priority: {\n        parent: 0,\n        exclusive: false,\n        weight: constants.DEFAULT_WEIGHT\n      },\n      id: streamId,\n      fin: false,\n      writable: true,\n      path: undefined,\n      headers: headers\n    })\n  })\n}\n\nParser.prototype.parseKVs = function parseKVs (buffer, callback) {\n  var self = this\n\n  this.decompress.write(buffer.toChunks(), function (err, chunks) {\n    if (err) {\n      return callback(err)\n    }\n\n    var buffer = new OffsetBuffer()\n    for (var i = 0; i < chunks.length; i++) {\n      buffer.push(chunks[i])\n    }\n\n    var size = self.version === 2 ? 2 : 4\n    if (!buffer.has(size)) { return callback(new Error('KV OOB')) }\n\n    var count = self.version === 2\n      ? buffer.readUInt16BE()\n      : buffer.readUInt32BE()\n\n    var headers = {}\n\n    function readString () {\n      if (!buffer.has(size)) { return null }\n      var len = self.version === 2\n        ? buffer.readUInt16BE()\n        : buffer.readUInt32BE()\n\n      if (!buffer.has(len)) { return null }\n\n      var value = buffer.take(len)\n      return value.toString()\n    }\n\n    while (count > 0) {\n      var key = readString()\n      var value = readString()\n\n      if (key === null || value === null) {\n        return callback(new Error('Headers OOB'))\n      }\n\n      if (self.version < 3) {\n        var isInternal = /^(method|version|url|host|scheme|status)$/.test(key)\n        if (key === 'url') {\n          key = 'path'\n        }\n        if (isInternal) {\n          key = ':' + key\n        }\n      }\n\n      // Compatibility with HTTP2\n      if (key === ':status') {\n        value = value.split(/ /g, 2)[0]\n      }\n\n      count--\n      if (key === ':host') {\n        key = ':authority'\n      }\n\n      // Skip version, not present in HTTP2\n      if (key === ':version') {\n        continue\n      }\n\n      value = value.split(/\\0/g)\n      for (var j = 0; j < value.length; j++) {\n        utils.addHeaderLine(key, value[j], headers)\n      }\n    }\n\n    callback(null, headers)\n  })\n}\n\nParser.prototype.onRSTFrame = function onRSTFrame (body, callback) {\n  if (!body.has(8)) { return callback(new Error('RST OOB')) }\n\n  var frame = {\n    type: 'RST',\n    id: body.readUInt32BE() & 0x7fffffff,\n    code: constants.errorByCode[body.readUInt32BE()]\n  }\n\n  if (frame.id === 0) {\n    return callback(this.error(constants.error.PROTOCOL_ERROR,\n      'Invalid stream id for RST'))\n  }\n\n  if (body.size !== 0) {\n    frame.extra = body.take(body.size)\n  }\n  callback(null, frame)\n}\n\nParser.prototype.onSettingsFrame = function onSettingsFrame (body, callback) {\n  if (!body.has(4)) {\n    return callback(new Error('SETTINGS OOB'))\n  }\n\n  var settings = {}\n  var number = body.readUInt32BE()\n  var idMap = {\n    1: 'upload_bandwidth',\n    2: 'download_bandwidth',\n    3: 'round_trip_time',\n    4: 'max_concurrent_streams',\n    5: 'current_cwnd',\n    6: 'download_retrans_rate',\n    7: 'initial_window_size',\n    8: 'client_certificate_vector_size'\n  }\n\n  if (!body.has(number * 8)) {\n    return callback(new Error('SETTINGS OOB#2'))\n  }\n\n  for (var i = 0; i < number; i++) {\n    var id = this.version === 2\n      ? body.readUInt32LE()\n      : body.readUInt32BE()\n\n    var flags = (id >> 24) & 0xff\n    id = id & 0xffffff\n\n    // Skip persisted settings\n    if (flags & 0x2) { continue }\n\n    var name = idMap[id]\n\n    settings[name] = body.readUInt32BE()\n  }\n\n  callback(null, {\n    type: 'SETTINGS',\n    settings: settings\n  })\n}\n\nParser.prototype.onPingFrame = function onPingFrame (body, callback) {\n  if (!body.has(4)) {\n    return callback(new Error('PING OOB'))\n  }\n\n  var isServer = this.isServer\n  var opaque = body.clone(body.size).take(body.size)\n  var id = body.readUInt32BE()\n  var ack = isServer ? (id % 2 === 0) : (id % 2 === 1)\n\n  callback(null, { type: 'PING', opaque: opaque, ack: ack })\n}\n\nParser.prototype.onGoawayFrame = function onGoawayFrame (body, callback) {\n  if (!body.has(8)) {\n    return callback(new Error('GOAWAY OOB'))\n  }\n\n  callback(null, {\n    type: 'GOAWAY',\n    lastId: body.readUInt32BE() & 0x7fffffff,\n    code: constants.goawayByCode[body.readUInt32BE()]\n  })\n}\n\nParser.prototype.onWindowUpdateFrame = function onWindowUpdateFrame (body,\n  callback) {\n  if (!body.has(8)) {\n    return callback(new Error('WINDOW_UPDATE OOB'))\n  }\n\n  callback(null, {\n    type: 'WINDOW_UPDATE',\n    id: body.readUInt32BE() & 0x7fffffff,\n    delta: body.readInt32BE()\n  })\n}\n\nParser.prototype.onXForwardedFrame = function onXForwardedFrame (body,\n  callback) {\n  if (!body.has(4)) {\n    return callback(new Error('X_FORWARDED OOB'))\n  }\n\n  var len = body.readUInt32BE()\n  if (!body.has(len)) { return callback(new Error('X_FORWARDED host length OOB')) }\n\n  callback(null, {\n    type: 'X_FORWARDED_FOR',\n    host: body.take(len).toString()\n  })\n}\n"]},"metadata":{},"sourceType":"script"}