{"ast":null,"code":"'use strict';\n\nvar RingBuffer = require('./ring_buffer');\n\nvar Functor = function (session, method) {\n  this._session = session;\n  this._method = method;\n  this._queue = new RingBuffer(Functor.QUEUE_SIZE);\n  this._stopped = false;\n  this.pending = 0;\n};\n\nFunctor.QUEUE_SIZE = 8;\n\nFunctor.prototype.call = function (error, message, callback, context) {\n  if (this._stopped) return;\n  var record = {\n    error: error,\n    message: message,\n    callback: callback,\n    context: context,\n    done: false\n  },\n      called = false,\n      self = this;\n\n  this._queue.push(record);\n\n  if (record.error) {\n    record.done = true;\n\n    this._stop();\n\n    return this._flushQueue();\n  }\n\n  var handler = function (err, msg) {\n    if (!(called ^ (called = true))) return;\n\n    if (err) {\n      self._stop();\n\n      record.error = err;\n      record.message = null;\n    } else {\n      record.message = msg;\n    }\n\n    record.done = true;\n\n    self._flushQueue();\n  };\n\n  try {\n    this._session[this._method](message, handler);\n  } catch (err) {\n    handler(err);\n  }\n};\n\nFunctor.prototype._stop = function () {\n  this.pending = this._queue.length;\n  this._stopped = true;\n};\n\nFunctor.prototype._flushQueue = function () {\n  var queue = this._queue,\n      record;\n\n  while (queue.length > 0 && queue.peek().done) {\n    record = queue.shift();\n\n    if (record.error) {\n      this.pending = 0;\n      queue.clear();\n    } else {\n      this.pending -= 1;\n    }\n\n    record.callback.call(record.context, record.error, record.message);\n  }\n};\n\nmodule.exports = Functor;","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/websocket-extensions/lib/pipeline/functor.js"],"names":["RingBuffer","require","Functor","session","method","_session","_method","_queue","QUEUE_SIZE","_stopped","pending","prototype","call","error","message","callback","context","record","done","called","self","push","_stop","_flushQueue","handler","err","msg","length","queue","peek","shift","clear","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar RingBuffer = require('./ring_buffer');\n\nvar Functor = function(session, method) {\n  this._session = session;\n  this._method  = method;\n  this._queue   = new RingBuffer(Functor.QUEUE_SIZE);\n  this._stopped = false;\n  this.pending  = 0;\n};\n\nFunctor.QUEUE_SIZE = 8;\n\nFunctor.prototype.call = function(error, message, callback, context) {\n  if (this._stopped) return;\n\n  var record = { error: error, message: message, callback: callback, context: context, done: false },\n      called = false,\n      self   = this;\n\n  this._queue.push(record);\n\n  if (record.error) {\n    record.done = true;\n    this._stop();\n    return this._flushQueue();\n  }\n\n  var handler = function(err, msg) {\n    if (!(called ^ (called = true))) return;\n\n    if (err) {\n      self._stop();\n      record.error   = err;\n      record.message = null;\n    } else {\n      record.message = msg;\n    }\n\n    record.done = true;\n    self._flushQueue();\n  };\n\n  try {\n    this._session[this._method](message, handler);\n  } catch (err) {\n    handler(err);\n  }\n};\n\nFunctor.prototype._stop = function() {\n  this.pending  = this._queue.length;\n  this._stopped = true;\n};\n\nFunctor.prototype._flushQueue = function() {\n  var queue = this._queue, record;\n\n  while (queue.length > 0 && queue.peek().done) {\n    record = queue.shift();\n    if (record.error) {\n      this.pending = 0;\n      queue.clear();\n    } else {\n      this.pending -= 1;\n    }\n    record.callback.call(record.context, record.error, record.message);\n  }\n};\n\nmodule.exports = Functor;\n"]},"metadata":{},"sourceType":"script"}