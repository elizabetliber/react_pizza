{"ast":null,"code":"'use strict';\n\nvar assert = require('assert');\n\nvar https = require('https');\n\nvar http = require('http');\n\nvar tls = require('tls');\n\nvar net = require('net');\n\nvar util = require('util');\n\nvar selectHose = require('select-hose');\n\nvar transport = require('spdy-transport');\n\nvar debug = require('debug')('spdy:server');\n\nvar EventEmitter = require('events').EventEmitter; // Node.js 0.8, 0.10 and 0.12 support\n\n\nObject.assign = process.versions.modules >= 46 ? Object.assign // eslint-disable-next-line\n: util._extend;\n\nvar spdy = require('../spdy');\n\nvar proto = {};\n\nfunction instantiate(base) {\n  function Server(options, handler) {\n    this._init(base, options, handler);\n  }\n\n  util.inherits(Server, base);\n\n  Server.create = function create(options, handler) {\n    return new Server(options, handler);\n  };\n\n  Object.keys(proto).forEach(function (key) {\n    Server.prototype[key] = proto[key];\n  });\n  return Server;\n}\n\nproto._init = function _init(base, options, handler) {\n  var state = {};\n  this._spdyState = state;\n  state.options = options.spdy || {};\n  var protocols = state.options.protocols || ['h2', 'spdy/3.1', 'spdy/3', 'spdy/2', 'http/1.1', 'http/1.0'];\n  var actualOptions = Object.assign({\n    NPNProtocols: protocols,\n    // Future-proof\n    ALPNProtocols: protocols\n  }, options);\n  state.secure = this instanceof tls.Server;\n\n  if (state.secure) {\n    base.call(this, actualOptions);\n  } else {\n    base.call(this);\n  } // Support HEADERS+FIN\n\n\n  this.httpAllowHalfOpen = true;\n  var event = state.secure ? 'secureConnection' : 'connection';\n  state.listeners = this.listeners(event).slice();\n  assert(state.listeners.length > 0, 'Server does not have default listeners');\n  this.removeAllListeners(event);\n\n  if (state.options.plain) {\n    this.on(event, this._onPlainConnection);\n  } else {\n    this.on(event, this._onConnection);\n  }\n\n  if (handler) {\n    this.on('request', handler);\n  }\n\n  debug('server init secure=%d', state.secure);\n};\n\nproto._onConnection = function _onConnection(socket) {\n  var state = this._spdyState;\n  var protocol;\n\n  if (state.secure) {\n    protocol = socket.npnProtocol || socket.alpnProtocol;\n  }\n\n  this._handleConnection(socket, protocol);\n};\n\nproto._handleConnection = function _handleConnection(socket, protocol) {\n  var state = this._spdyState;\n\n  if (!protocol) {\n    protocol = state.options.protocol;\n  }\n\n  debug('incoming socket protocol=%j', protocol); // No way we can do anything with the socket\n\n  if (!protocol || protocol === 'http/1.1' || protocol === 'http/1.0') {\n    debug('to default handler it goes');\n    return this._invokeDefault(socket);\n  }\n\n  socket.setNoDelay(true);\n  var connection = transport.connection.create(socket, Object.assign({\n    protocol: /spdy/.test(protocol) ? 'spdy' : 'http2',\n    isServer: true\n  }, state.options.connection || {})); // Set version when we are certain\n\n  if (protocol === 'http2') {\n    connection.start(4);\n  } else if (protocol === 'spdy/3.1') {\n    connection.start(3.1);\n  } else if (protocol === 'spdy/3') {\n    connection.start(3);\n  } else if (protocol === 'spdy/2') {\n    connection.start(2);\n  }\n\n  connection.on('error', function () {\n    socket.destroy();\n  });\n  var self = this;\n  connection.on('stream', function (stream) {\n    self._onStream(stream);\n  });\n}; // HTTP2 preface\n\n\nvar PREFACE = 'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n';\nvar PREFACE_BUFFER = Buffer.from(PREFACE);\n\nfunction hoseFilter(data, callback) {\n  if (data.length < 1) {\n    return callback(null, null);\n  } // SPDY!\n\n\n  if (data[0] === 0x80) {\n    return callback(null, 'spdy');\n  }\n\n  var avail = Math.min(data.length, PREFACE_BUFFER.length);\n\n  for (var i = 0; i < avail; i++) {\n    if (data[i] !== PREFACE_BUFFER[i]) {\n      return callback(null, 'http/1.1');\n    }\n  } // Not enough bytes to be sure about HTTP2\n\n\n  if (avail !== PREFACE_BUFFER.length) {\n    return callback(null, null);\n  }\n\n  return callback(null, 'h2');\n}\n\nproto._onPlainConnection = function _onPlainConnection(socket) {\n  var hose = selectHose.create(socket, {}, hoseFilter);\n  var self = this;\n  hose.on('select', function (protocol, socket) {\n    self._handleConnection(socket, protocol);\n  });\n  hose.on('error', function (err) {\n    debug('hose error %j', err.message);\n    socket.destroy();\n  });\n};\n\nproto._invokeDefault = function _invokeDefault(socket) {\n  var state = this._spdyState;\n\n  for (var i = 0; i < state.listeners.length; i++) {\n    state.listeners[i].call(this, socket);\n  }\n};\n\nproto._onStream = function _onStream(stream) {\n  var state = this._spdyState;\n  var handle = spdy.handle.create(this._spdyState.options, stream);\n  var socketOptions = {\n    handle: handle,\n    allowHalfOpen: true\n  };\n  var socket;\n\n  if (state.secure) {\n    socket = new spdy.Socket(stream.connection.socket, socketOptions);\n  } else {\n    socket = new net.Socket(socketOptions);\n  } // This is needed because the `error` listener, added by the default\n  // `connection` listener, no longer has bound arguments. It relies instead\n  // on the `server` property of the socket. See https://github.com/nodejs/node/pull/11926\n  // for more details.\n  // This is only done for Node.js >= 4 in order to not break compatibility\n  // with older versions of the platform.\n\n\n  if (process.versions.modules >= 46) {\n    socket.server = this;\n  }\n\n  handle.assignSocket(socket); // For v0.8\n\n  socket.readable = true;\n  socket.writable = true;\n\n  this._invokeDefault(socket); // For v0.8, 0.10 and 0.12\n\n\n  if (process.versions.modules < 46) {\n    // eslint-disable-next-line\n    this.listenerCount = EventEmitter.listenerCount.bind(this);\n  } // Add lazy `checkContinue` listener, otherwise `res.writeContinue` will be\n  // called before the response object was patched by us.\n\n\n  if (stream.headers.expect !== undefined && /100-continue/i.test(stream.headers.expect) && this.listenerCount('checkContinue') === 0) {\n    this.once('checkContinue', function (req, res) {\n      res.writeContinue();\n      this.emit('request', req, res);\n    });\n  }\n\n  handle.emitRequest();\n};\n\nproto.emit = function emit(event, req, res) {\n  if (event !== 'request' && event !== 'checkContinue') {\n    return EventEmitter.prototype.emit.apply(this, arguments);\n  }\n\n  if (!(req.socket._handle instanceof spdy.handle)) {\n    debug('not spdy req/res');\n    req.isSpdy = false;\n    req.spdyVersion = 1;\n    res.isSpdy = false;\n    res.spdyVersion = 1;\n    return EventEmitter.prototype.emit.apply(this, arguments);\n  }\n\n  var handle = req.connection._handle;\n  req.isSpdy = true;\n  req.spdyVersion = handle.getStream().connection.getVersion();\n  res.isSpdy = true;\n  res.spdyVersion = req.spdyVersion;\n  req.spdyStream = handle.getStream();\n  debug('override req/res');\n  res.writeHead = spdy.response.writeHead;\n  res.end = spdy.response.end;\n  res.push = spdy.response.push;\n  res.writeContinue = spdy.response.writeContinue;\n  res.spdyStream = handle.getStream();\n  res._req = req;\n  handle.assignRequest(req);\n  handle.assignResponse(res);\n  return EventEmitter.prototype.emit.apply(this, arguments);\n};\n\nexports.Server = instantiate(https.Server);\nexports.PlainServer = instantiate(http.Server);\n\nexports.create = function create(base, options, handler) {\n  if (typeof base === 'object') {\n    handler = options;\n    options = base;\n    base = null;\n  }\n\n  if (base) {\n    return instantiate(base).create(options, handler);\n  }\n\n  if (options.spdy && options.spdy.plain) {\n    return exports.PlainServer.create(options, handler);\n  } else {\n    return exports.Server.create(options, handler);\n  }\n};","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/spdy/lib/spdy/server.js"],"names":["assert","require","https","http","tls","net","util","selectHose","transport","debug","EventEmitter","Object","assign","process","versions","modules","_extend","spdy","proto","instantiate","base","Server","options","handler","_init","inherits","create","keys","forEach","key","prototype","state","_spdyState","protocols","actualOptions","NPNProtocols","ALPNProtocols","secure","call","httpAllowHalfOpen","event","listeners","slice","length","removeAllListeners","plain","on","_onPlainConnection","_onConnection","socket","protocol","npnProtocol","alpnProtocol","_handleConnection","_invokeDefault","setNoDelay","connection","test","isServer","start","destroy","self","stream","_onStream","PREFACE","PREFACE_BUFFER","Buffer","from","hoseFilter","data","callback","avail","Math","min","i","hose","err","message","handle","socketOptions","allowHalfOpen","Socket","server","assignSocket","readable","writable","listenerCount","bind","headers","expect","undefined","once","req","res","writeContinue","emit","emitRequest","apply","arguments","_handle","isSpdy","spdyVersion","getStream","getVersion","spdyStream","writeHead","response","end","push","_req","assignRequest","assignResponse","exports","PlainServer"],"mappings":"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","sourcesContent":["'use strict'\n\nvar assert = require('assert')\nvar https = require('https')\nvar http = require('http')\nvar tls = require('tls')\nvar net = require('net')\nvar util = require('util')\nvar selectHose = require('select-hose')\nvar transport = require('spdy-transport')\nvar debug = require('debug')('spdy:server')\nvar EventEmitter = require('events').EventEmitter\n\n// Node.js 0.8, 0.10 and 0.12 support\nObject.assign = process.versions.modules >= 46\n  ? Object.assign // eslint-disable-next-line\n  : util._extend\n\nvar spdy = require('../spdy')\n\nvar proto = {}\n\nfunction instantiate (base) {\n  function Server (options, handler) {\n    this._init(base, options, handler)\n  }\n  util.inherits(Server, base)\n\n  Server.create = function create (options, handler) {\n    return new Server(options, handler)\n  }\n\n  Object.keys(proto).forEach(function (key) {\n    Server.prototype[key] = proto[key]\n  })\n\n  return Server\n}\n\nproto._init = function _init (base, options, handler) {\n  var state = {}\n  this._spdyState = state\n\n  state.options = options.spdy || {}\n\n  var protocols = state.options.protocols || [\n    'h2',\n    'spdy/3.1', 'spdy/3', 'spdy/2',\n    'http/1.1', 'http/1.0'\n  ]\n\n  var actualOptions = Object.assign({\n    NPNProtocols: protocols,\n\n    // Future-proof\n    ALPNProtocols: protocols\n  }, options)\n\n  state.secure = this instanceof tls.Server\n\n  if (state.secure) {\n    base.call(this, actualOptions)\n  } else {\n    base.call(this)\n  }\n\n  // Support HEADERS+FIN\n  this.httpAllowHalfOpen = true\n\n  var event = state.secure ? 'secureConnection' : 'connection'\n\n  state.listeners = this.listeners(event).slice()\n  assert(state.listeners.length > 0, 'Server does not have default listeners')\n  this.removeAllListeners(event)\n\n  if (state.options.plain) {\n    this.on(event, this._onPlainConnection)\n  } else { this.on(event, this._onConnection) }\n\n  if (handler) {\n    this.on('request', handler)\n  }\n\n  debug('server init secure=%d', state.secure)\n}\n\nproto._onConnection = function _onConnection (socket) {\n  var state = this._spdyState\n\n  var protocol\n  if (state.secure) {\n    protocol = socket.npnProtocol || socket.alpnProtocol\n  }\n\n  this._handleConnection(socket, protocol)\n}\n\nproto._handleConnection = function _handleConnection (socket, protocol) {\n  var state = this._spdyState\n\n  if (!protocol) {\n    protocol = state.options.protocol\n  }\n\n  debug('incoming socket protocol=%j', protocol)\n\n  // No way we can do anything with the socket\n  if (!protocol || protocol === 'http/1.1' || protocol === 'http/1.0') {\n    debug('to default handler it goes')\n    return this._invokeDefault(socket)\n  }\n\n  socket.setNoDelay(true)\n\n  var connection = transport.connection.create(socket, Object.assign({\n    protocol: /spdy/.test(protocol) ? 'spdy' : 'http2',\n    isServer: true\n  }, state.options.connection || {}))\n\n  // Set version when we are certain\n  if (protocol === 'http2') { connection.start(4) } else if (protocol === 'spdy/3.1') {\n    connection.start(3.1)\n  } else if (protocol === 'spdy/3') { connection.start(3) } else if (protocol === 'spdy/2') {\n    connection.start(2)\n  }\n\n  connection.on('error', function () {\n    socket.destroy()\n  })\n\n  var self = this\n  connection.on('stream', function (stream) {\n    self._onStream(stream)\n  })\n}\n\n// HTTP2 preface\nvar PREFACE = 'PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n'\nvar PREFACE_BUFFER = Buffer.from(PREFACE)\n\nfunction hoseFilter (data, callback) {\n  if (data.length < 1) {\n    return callback(null, null)\n  }\n\n  // SPDY!\n  if (data[0] === 0x80) { return callback(null, 'spdy') }\n\n  var avail = Math.min(data.length, PREFACE_BUFFER.length)\n  for (var i = 0; i < avail; i++) {\n    if (data[i] !== PREFACE_BUFFER[i]) { return callback(null, 'http/1.1') }\n  }\n\n  // Not enough bytes to be sure about HTTP2\n  if (avail !== PREFACE_BUFFER.length) { return callback(null, null) }\n\n  return callback(null, 'h2')\n}\n\nproto._onPlainConnection = function _onPlainConnection (socket) {\n  var hose = selectHose.create(socket, {}, hoseFilter)\n\n  var self = this\n  hose.on('select', function (protocol, socket) {\n    self._handleConnection(socket, protocol)\n  })\n\n  hose.on('error', function (err) {\n    debug('hose error %j', err.message)\n    socket.destroy()\n  })\n}\n\nproto._invokeDefault = function _invokeDefault (socket) {\n  var state = this._spdyState\n\n  for (var i = 0; i < state.listeners.length; i++) { state.listeners[i].call(this, socket) }\n}\n\nproto._onStream = function _onStream (stream) {\n  var state = this._spdyState\n\n  var handle = spdy.handle.create(this._spdyState.options, stream)\n\n  var socketOptions = {\n    handle: handle,\n    allowHalfOpen: true\n  }\n\n  var socket\n  if (state.secure) {\n    socket = new spdy.Socket(stream.connection.socket, socketOptions)\n  } else {\n    socket = new net.Socket(socketOptions)\n  }\n\n  // This is needed because the `error` listener, added by the default\n  // `connection` listener, no longer has bound arguments. It relies instead\n  // on the `server` property of the socket. See https://github.com/nodejs/node/pull/11926\n  // for more details.\n  // This is only done for Node.js >= 4 in order to not break compatibility\n  // with older versions of the platform.\n  if (process.versions.modules >= 46) { socket.server = this }\n\n  handle.assignSocket(socket)\n\n  // For v0.8\n  socket.readable = true\n  socket.writable = true\n\n  this._invokeDefault(socket)\n\n  // For v0.8, 0.10 and 0.12\n  if (process.versions.modules < 46) {\n    // eslint-disable-next-line\n    this.listenerCount = EventEmitter.listenerCount.bind(this)\n  }\n\n  // Add lazy `checkContinue` listener, otherwise `res.writeContinue` will be\n  // called before the response object was patched by us.\n  if (stream.headers.expect !== undefined &&\n      /100-continue/i.test(stream.headers.expect) &&\n      this.listenerCount('checkContinue') === 0) {\n    this.once('checkContinue', function (req, res) {\n      res.writeContinue()\n\n      this.emit('request', req, res)\n    })\n  }\n\n  handle.emitRequest()\n}\n\nproto.emit = function emit (event, req, res) {\n  if (event !== 'request' && event !== 'checkContinue') {\n    return EventEmitter.prototype.emit.apply(this, arguments)\n  }\n\n  if (!(req.socket._handle instanceof spdy.handle)) {\n    debug('not spdy req/res')\n    req.isSpdy = false\n    req.spdyVersion = 1\n    res.isSpdy = false\n    res.spdyVersion = 1\n    return EventEmitter.prototype.emit.apply(this, arguments)\n  }\n\n  var handle = req.connection._handle\n\n  req.isSpdy = true\n  req.spdyVersion = handle.getStream().connection.getVersion()\n  res.isSpdy = true\n  res.spdyVersion = req.spdyVersion\n  req.spdyStream = handle.getStream()\n\n  debug('override req/res')\n  res.writeHead = spdy.response.writeHead\n  res.end = spdy.response.end\n  res.push = spdy.response.push\n  res.writeContinue = spdy.response.writeContinue\n  res.spdyStream = handle.getStream()\n\n  res._req = req\n\n  handle.assignRequest(req)\n  handle.assignResponse(res)\n\n  return EventEmitter.prototype.emit.apply(this, arguments)\n}\n\nexports.Server = instantiate(https.Server)\nexports.PlainServer = instantiate(http.Server)\n\nexports.create = function create (base, options, handler) {\n  if (typeof base === 'object') {\n    handler = options\n    options = base\n    base = null\n  }\n\n  if (base) {\n    return instantiate(base).create(options, handler)\n  }\n\n  if (options.spdy && options.spdy.plain) { return exports.PlainServer.create(options, handler) } else {\n    return exports.Server.create(options, handler)\n  }\n}\n"]},"metadata":{},"sourceType":"script"}