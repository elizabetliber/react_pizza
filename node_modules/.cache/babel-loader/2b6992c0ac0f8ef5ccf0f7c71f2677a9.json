{"ast":null,"code":"'use strict';\n\nvar transport = require('../../../spdy-transport');\n\nvar base = transport.protocol.base;\n\nvar constants = require('./').constants;\n\nvar assert = require('assert');\n\nvar util = require('util');\n\nvar WriteBuffer = require('wbuf');\n\nvar OffsetBuffer = require('obuf');\n\nvar debug = require('debug')('spdy:framer');\n\nvar debugExtra = require('debug')('spdy:framer:extra');\n\nfunction Framer(options) {\n  base.Framer.call(this, options);\n  this.maxFrameSize = constants.INITIAL_MAX_FRAME_SIZE;\n}\n\nutil.inherits(Framer, base.Framer);\nmodule.exports = Framer;\n\nFramer.create = function create(options) {\n  return new Framer(options);\n};\n\nFramer.prototype.setMaxFrameSize = function setMaxFrameSize(size) {\n  this.maxFrameSize = size;\n};\n\nFramer.prototype._frame = function _frame(frame, body, callback) {\n  debug('id=%d type=%s', frame.id, frame.type);\n  var buffer = new WriteBuffer();\n  buffer.reserve(constants.FRAME_HEADER_SIZE);\n  var len = buffer.skip(3);\n  buffer.writeUInt8(constants.frameType[frame.type]);\n  buffer.writeUInt8(frame.flags);\n  buffer.writeUInt32BE(frame.id & 0x7fffffff);\n  body(buffer);\n  var frameSize = buffer.size - constants.FRAME_HEADER_SIZE;\n  len.writeUInt24BE(frameSize);\n  var chunks = buffer.render();\n  var toWrite = {\n    stream: frame.id,\n    priority: frame.priority === undefined ? false : frame.priority,\n    chunks: chunks,\n    callback: callback\n  };\n\n  if (this.window && frame.type === 'DATA') {\n    var self = this;\n\n    this._resetTimeout();\n\n    this.window.send.update(-frameSize, function () {\n      self._resetTimeout();\n\n      self.schedule(toWrite);\n    });\n  } else {\n    this._resetTimeout();\n\n    this.schedule(toWrite);\n  }\n\n  return chunks;\n};\n\nFramer.prototype._split = function _split(frame) {\n  var buf = new OffsetBuffer();\n\n  for (var i = 0; i < frame.chunks.length; i++) {\n    buf.push(frame.chunks[i]);\n  }\n\n  var frames = [];\n\n  while (!buf.isEmpty()) {\n    // First frame may have reserved bytes in it\n    var size = this.maxFrameSize;\n\n    if (frames.length === 0) {\n      size -= frame.reserve;\n    }\n\n    size = Math.min(size, buf.size);\n    var frameBuf = buf.clone(size);\n    buf.skip(size);\n    frames.push({\n      size: frameBuf.size,\n      chunks: frameBuf.toChunks()\n    });\n  }\n\n  return frames;\n};\n\nFramer.prototype._continuationFrame = function _continuationFrame(frame, body, callback) {\n  var frames = this._split(frame);\n\n  frames.forEach(function (subFrame, i) {\n    var isFirst = i === 0;\n    var isLast = i === frames.length - 1;\n    var flags = isLast ? constants.flags.END_HEADERS : 0; // PRIORITY and friends\n\n    if (isFirst) {\n      flags |= frame.flags;\n    }\n\n    this._frame({\n      id: frame.id,\n      priority: false,\n      type: isFirst ? frame.type : 'CONTINUATION',\n      flags: flags\n    }, function (buf) {\n      // Fill those reserved bytes\n      if (isFirst && body) {\n        body(buf);\n      }\n\n      buf.reserve(subFrame.size);\n\n      for (var i = 0; i < subFrame.chunks.length; i++) {\n        buf.copyFrom(subFrame.chunks[i]);\n      }\n    }, isLast ? callback : null);\n  }, this);\n\n  if (frames.length === 0) {\n    this._frame({\n      id: frame.id,\n      priority: false,\n      type: frame.type,\n      flags: frame.flags | constants.flags.END_HEADERS\n    }, function (buf) {\n      if (body) {\n        body(buf);\n      }\n    }, callback);\n  }\n};\n\nFramer.prototype._compressHeaders = function _compressHeaders(headers, pairs, callback) {\n  Object.keys(headers || {}).forEach(function (name) {\n    var lowName = name.toLowerCase(); // Not allowed in HTTP2\n\n    switch (lowName) {\n      case 'host':\n      case 'connection':\n      case 'keep-alive':\n      case 'proxy-connection':\n      case 'transfer-encoding':\n      case 'upgrade':\n        return;\n    } // Should be in `pairs`\n\n\n    if (/^:/.test(lowName)) {\n      return;\n    } // Do not compress, or index Cookie field (for security reasons)\n\n\n    var neverIndex = lowName === 'cookie' || lowName === 'set-cookie';\n    var value = headers[name];\n\n    if (Array.isArray(value)) {\n      for (var i = 0; i < value.length; i++) {\n        pairs.push({\n          name: lowName,\n          value: value[i] + '',\n          neverIndex: neverIndex,\n          huffman: !neverIndex\n        });\n      }\n    } else {\n      pairs.push({\n        name: lowName,\n        value: value + '',\n        neverIndex: neverIndex,\n        huffman: !neverIndex\n      });\n    }\n  });\n  assert(this.compress !== null, 'Framer version not initialized');\n  debugExtra('compressing headers=%j', pairs);\n  this.compress.write([pairs], callback);\n};\n\nFramer.prototype._isDefaultPriority = function _isDefaultPriority(priority) {\n  if (!priority) {\n    return true;\n  }\n\n  return !priority.parent && priority.weight === constants.DEFAULT && !priority.exclusive;\n};\n\nFramer.prototype._defaultHeaders = function _defaultHeaders(frame, pairs) {\n  if (!frame.path) {\n    throw new Error('`path` is required frame argument');\n  }\n\n  pairs.push({\n    name: ':method',\n    value: frame.method || base.constants.DEFAULT_METHOD\n  });\n  pairs.push({\n    name: ':path',\n    value: frame.path\n  });\n  pairs.push({\n    name: ':scheme',\n    value: frame.scheme || 'https'\n  });\n  pairs.push({\n    name: ':authority',\n    value: frame.host || frame.headers && frame.headers.host || base.constants.DEFAULT_HOST\n  });\n};\n\nFramer.prototype._headersFrame = function _headersFrame(kind, frame, callback) {\n  var pairs = [];\n\n  if (kind === 'request') {\n    this._defaultHeaders(frame, pairs);\n  } else if (kind === 'response') {\n    pairs.push({\n      name: ':status',\n      value: (frame.status || 200) + ''\n    });\n  }\n\n  var self = this;\n\n  this._compressHeaders(frame.headers, pairs, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err);\n      } else {\n        return self.emit('error', err);\n      }\n    }\n\n    var reserve = 0; // If priority info is present, and the values are not default ones\n    // reserve space for the priority info and add PRIORITY flag\n\n    var priority = frame.priority;\n\n    if (!self._isDefaultPriority(priority)) {\n      reserve = 5;\n    }\n\n    var flags = reserve === 0 ? 0 : constants.flags.PRIORITY; // Mostly for testing\n\n    if (frame.fin) {\n      flags |= constants.flags.END_STREAM;\n    }\n\n    self._continuationFrame({\n      id: frame.id,\n      type: 'HEADERS',\n      flags: flags,\n      reserve: reserve,\n      chunks: chunks\n    }, function (buf) {\n      if (reserve === 0) {\n        return;\n      }\n\n      buf.writeUInt32BE(((priority.exclusive ? 0x80000000 : 0) | priority.parent) >>> 0);\n      buf.writeUInt8((priority.weight | 0) - 1);\n    }, callback);\n  });\n};\n\nFramer.prototype.requestFrame = function requestFrame(frame, callback) {\n  return this._headersFrame('request', frame, callback);\n};\n\nFramer.prototype.responseFrame = function responseFrame(frame, callback) {\n  return this._headersFrame('response', frame, callback);\n};\n\nFramer.prototype.headersFrame = function headersFrame(frame, callback) {\n  return this._headersFrame('headers', frame, callback);\n};\n\nFramer.prototype.pushFrame = function pushFrame(frame, callback) {\n  var self = this;\n\n  function compress(headers, pairs, callback) {\n    self._compressHeaders(headers, pairs, function (err, chunks) {\n      if (err) {\n        if (callback) {\n          return callback(err);\n        } else {\n          return self.emit('error', err);\n        }\n      }\n\n      callback(chunks);\n    });\n  }\n\n  function sendPromise(chunks) {\n    self._continuationFrame({\n      id: frame.id,\n      type: 'PUSH_PROMISE',\n      reserve: 4,\n      chunks: chunks\n    }, function (buf) {\n      buf.writeUInt32BE(frame.promisedId);\n    });\n  }\n\n  function sendResponse(chunks, callback) {\n    var priority = frame.priority;\n\n    var isDefaultPriority = self._isDefaultPriority(priority);\n\n    var flags = isDefaultPriority ? 0 : constants.flags.PRIORITY; // Mostly for testing\n\n    if (frame.fin) {\n      flags |= constants.flags.END_STREAM;\n    }\n\n    self._continuationFrame({\n      id: frame.promisedId,\n      type: 'HEADERS',\n      flags: flags,\n      reserve: isDefaultPriority ? 0 : 5,\n      chunks: chunks\n    }, function (buf) {\n      if (isDefaultPriority) {\n        return;\n      }\n\n      buf.writeUInt32BE((priority.exclusive ? 0x80000000 : 0) | priority.parent);\n      buf.writeUInt8((priority.weight | 0) - 1);\n    }, callback);\n  }\n\n  this._checkPush(function (err) {\n    if (err) {\n      return callback(err);\n    }\n\n    var pairs = {\n      promise: [],\n      response: []\n    };\n\n    self._defaultHeaders(frame, pairs.promise);\n\n    pairs.response.push({\n      name: ':status',\n      value: (frame.status || 200) + ''\n    });\n    compress(frame.headers, pairs.promise, function (promiseChunks) {\n      sendPromise(promiseChunks);\n\n      if (frame.response === false) {\n        return callback(null);\n      }\n\n      compress(frame.response, pairs.response, function (responseChunks) {\n        sendResponse(responseChunks, callback);\n      });\n    });\n  });\n};\n\nFramer.prototype.priorityFrame = function priorityFrame(frame, callback) {\n  this._frame({\n    id: frame.id,\n    priority: false,\n    type: 'PRIORITY',\n    flags: 0\n  }, function (buf) {\n    var priority = frame.priority;\n    buf.writeUInt32BE((priority.exclusive ? 0x80000000 : 0) | priority.parent);\n    buf.writeUInt8((priority.weight | 0) - 1);\n  }, callback);\n};\n\nFramer.prototype.dataFrame = function dataFrame(frame, callback) {\n  var frames = this._split({\n    reserve: 0,\n    chunks: [frame.data]\n  });\n\n  var fin = frame.fin ? constants.flags.END_STREAM : 0;\n  var self = this;\n  frames.forEach(function (subFrame, i) {\n    var isLast = i === frames.length - 1;\n    var flags = 0;\n\n    if (isLast) {\n      flags |= fin;\n    }\n\n    self._frame({\n      id: frame.id,\n      priority: frame.priority,\n      type: 'DATA',\n      flags: flags\n    }, function (buf) {\n      buf.reserve(subFrame.size);\n\n      for (var i = 0; i < subFrame.chunks.length; i++) {\n        buf.copyFrom(subFrame.chunks[i]);\n      }\n    }, isLast ? callback : null);\n  }); // Empty DATA\n\n  if (frames.length === 0) {\n    this._frame({\n      id: frame.id,\n      priority: frame.priority,\n      type: 'DATA',\n      flags: fin\n    }, function (buf) {// No-op\n    }, callback);\n  }\n};\n\nFramer.prototype.pingFrame = function pingFrame(frame, callback) {\n  this._frame({\n    id: 0,\n    type: 'PING',\n    flags: frame.ack ? constants.flags.ACK : 0\n  }, function (buf) {\n    buf.copyFrom(frame.opaque);\n  }, callback);\n};\n\nFramer.prototype.rstFrame = function rstFrame(frame, callback) {\n  this._frame({\n    id: frame.id,\n    type: 'RST_STREAM',\n    flags: 0\n  }, function (buf) {\n    buf.writeUInt32BE(constants.error[frame.code]);\n  }, callback);\n};\n\nFramer.prototype.prefaceFrame = function prefaceFrame(callback) {\n  debug('preface');\n\n  this._resetTimeout();\n\n  this.schedule({\n    stream: 0,\n    priority: false,\n    chunks: [constants.PREFACE_BUFFER],\n    callback: callback\n  });\n};\n\nFramer.prototype.settingsFrame = function settingsFrame(options, callback) {\n  var key = JSON.stringify(options);\n  var settings = Framer.settingsCache[key];\n\n  if (settings) {\n    debug('cached settings');\n\n    this._resetTimeout();\n\n    this.schedule({\n      id: 0,\n      priority: false,\n      chunks: settings,\n      callback: callback\n    });\n    return;\n  }\n\n  var params = [];\n\n  for (var i = 0; i < constants.settingsIndex.length; i++) {\n    var name = constants.settingsIndex[i];\n\n    if (!name) {\n      continue;\n    } // value: Infinity\n\n\n    if (!isFinite(options[name])) {\n      continue;\n    }\n\n    if (options[name] !== undefined) {\n      params.push({\n        key: i,\n        value: options[name]\n      });\n    }\n  }\n\n  var bodySize = params.length * 6;\n\n  var chunks = this._frame({\n    id: 0,\n    type: 'SETTINGS',\n    flags: 0\n  }, function (buffer) {\n    buffer.reserve(bodySize);\n\n    for (var i = 0; i < params.length; i++) {\n      var param = params[i];\n      buffer.writeUInt16BE(param.key);\n      buffer.writeUInt32BE(param.value);\n    }\n  }, callback);\n\n  Framer.settingsCache[key] = chunks;\n};\n\nFramer.settingsCache = {};\n\nFramer.prototype.ackSettingsFrame = function ackSettingsFrame(callback) {\n  /* var chunks = */\n  this._frame({\n    id: 0,\n    type: 'SETTINGS',\n    flags: constants.flags.ACK\n  }, function (buffer) {// No-op\n  }, callback);\n};\n\nFramer.prototype.windowUpdateFrame = function windowUpdateFrame(frame, callback) {\n  this._frame({\n    id: frame.id,\n    type: 'WINDOW_UPDATE',\n    flags: 0\n  }, function (buffer) {\n    buffer.reserve(4);\n    buffer.writeInt32BE(frame.delta);\n  }, callback);\n};\n\nFramer.prototype.goawayFrame = function goawayFrame(frame, callback) {\n  this._frame({\n    type: 'GOAWAY',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8); // Last-good-stream-ID\n\n    buf.writeUInt32BE(frame.lastId & 0x7fffffff); // Code\n\n    buf.writeUInt32BE(constants.goaway[frame.code]); // Extra debugging information\n\n    if (frame.extra) {\n      buf.write(frame.extra);\n    }\n  }, callback);\n};\n\nFramer.prototype.xForwardedFor = function xForwardedFor(frame, callback) {\n  this._frame({\n    type: 'X_FORWARDED_FOR',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.write(frame.host);\n  }, callback);\n};","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/spdy-transport/lib/spdy-transport/protocol/http2/framer.js"],"names":["transport","require","base","protocol","constants","assert","util","WriteBuffer","OffsetBuffer","debug","debugExtra","Framer","options","call","maxFrameSize","INITIAL_MAX_FRAME_SIZE","inherits","module","exports","create","prototype","setMaxFrameSize","size","_frame","frame","body","callback","id","type","buffer","reserve","FRAME_HEADER_SIZE","len","skip","writeUInt8","frameType","flags","writeUInt32BE","frameSize","writeUInt24BE","chunks","render","toWrite","stream","priority","undefined","window","self","_resetTimeout","send","update","schedule","_split","buf","i","length","push","frames","isEmpty","Math","min","frameBuf","clone","toChunks","_continuationFrame","forEach","subFrame","isFirst","isLast","END_HEADERS","copyFrom","_compressHeaders","headers","pairs","Object","keys","name","lowName","toLowerCase","test","neverIndex","value","Array","isArray","huffman","compress","write","_isDefaultPriority","parent","weight","DEFAULT","exclusive","_defaultHeaders","path","Error","method","DEFAULT_METHOD","scheme","host","DEFAULT_HOST","_headersFrame","kind","status","err","emit","PRIORITY","fin","END_STREAM","requestFrame","responseFrame","headersFrame","pushFrame","sendPromise","promisedId","sendResponse","isDefaultPriority","_checkPush","promise","response","promiseChunks","responseChunks","priorityFrame","dataFrame","data","pingFrame","ack","ACK","opaque","rstFrame","error","code","prefaceFrame","PREFACE_BUFFER","settingsFrame","key","JSON","stringify","settings","settingsCache","params","settingsIndex","isFinite","bodySize","param","writeUInt16BE","ackSettingsFrame","windowUpdateFrame","writeInt32BE","delta","goawayFrame","lastId","goaway","extra","xForwardedFor"],"mappings":"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","sourcesContent":["'use strict'\n\nvar transport = require('../../../spdy-transport')\nvar base = transport.protocol.base\nvar constants = require('./').constants\n\nvar assert = require('assert')\nvar util = require('util')\nvar WriteBuffer = require('wbuf')\nvar OffsetBuffer = require('obuf')\nvar debug = require('debug')('spdy:framer')\nvar debugExtra = require('debug')('spdy:framer:extra')\n\nfunction Framer (options) {\n  base.Framer.call(this, options)\n\n  this.maxFrameSize = constants.INITIAL_MAX_FRAME_SIZE\n}\nutil.inherits(Framer, base.Framer)\nmodule.exports = Framer\n\nFramer.create = function create (options) {\n  return new Framer(options)\n}\n\nFramer.prototype.setMaxFrameSize = function setMaxFrameSize (size) {\n  this.maxFrameSize = size\n}\n\nFramer.prototype._frame = function _frame (frame, body, callback) {\n  debug('id=%d type=%s', frame.id, frame.type)\n\n  var buffer = new WriteBuffer()\n\n  buffer.reserve(constants.FRAME_HEADER_SIZE)\n  var len = buffer.skip(3)\n  buffer.writeUInt8(constants.frameType[frame.type])\n  buffer.writeUInt8(frame.flags)\n  buffer.writeUInt32BE(frame.id & 0x7fffffff)\n\n  body(buffer)\n\n  var frameSize = buffer.size - constants.FRAME_HEADER_SIZE\n  len.writeUInt24BE(frameSize)\n\n  var chunks = buffer.render()\n  var toWrite = {\n    stream: frame.id,\n    priority: frame.priority === undefined ? false : frame.priority,\n    chunks: chunks,\n    callback: callback\n  }\n\n  if (this.window && frame.type === 'DATA') {\n    var self = this\n    this._resetTimeout()\n    this.window.send.update(-frameSize, function () {\n      self._resetTimeout()\n      self.schedule(toWrite)\n    })\n  } else {\n    this._resetTimeout()\n    this.schedule(toWrite)\n  }\n\n  return chunks\n}\n\nFramer.prototype._split = function _split (frame) {\n  var buf = new OffsetBuffer()\n  for (var i = 0; i < frame.chunks.length; i++) { buf.push(frame.chunks[i]) }\n\n  var frames = []\n  while (!buf.isEmpty()) {\n    // First frame may have reserved bytes in it\n    var size = this.maxFrameSize\n    if (frames.length === 0) {\n      size -= frame.reserve\n    }\n    size = Math.min(size, buf.size)\n\n    var frameBuf = buf.clone(size)\n    buf.skip(size)\n\n    frames.push({\n      size: frameBuf.size,\n      chunks: frameBuf.toChunks()\n    })\n  }\n\n  return frames\n}\n\nFramer.prototype._continuationFrame = function _continuationFrame (frame,\n  body,\n  callback) {\n  var frames = this._split(frame)\n\n  frames.forEach(function (subFrame, i) {\n    var isFirst = i === 0\n    var isLast = i === frames.length - 1\n\n    var flags = isLast ? constants.flags.END_HEADERS : 0\n\n    // PRIORITY and friends\n    if (isFirst) {\n      flags |= frame.flags\n    }\n\n    this._frame({\n      id: frame.id,\n      priority: false,\n      type: isFirst ? frame.type : 'CONTINUATION',\n      flags: flags\n    }, function (buf) {\n      // Fill those reserved bytes\n      if (isFirst && body) { body(buf) }\n\n      buf.reserve(subFrame.size)\n      for (var i = 0; i < subFrame.chunks.length; i++) { buf.copyFrom(subFrame.chunks[i]) }\n    }, isLast ? callback : null)\n  }, this)\n\n  if (frames.length === 0) {\n    this._frame({\n      id: frame.id,\n      priority: false,\n      type: frame.type,\n      flags: frame.flags | constants.flags.END_HEADERS\n    }, function (buf) {\n      if (body) { body(buf) }\n    }, callback)\n  }\n}\n\nFramer.prototype._compressHeaders = function _compressHeaders (headers,\n  pairs,\n  callback) {\n  Object.keys(headers || {}).forEach(function (name) {\n    var lowName = name.toLowerCase()\n\n    // Not allowed in HTTP2\n    switch (lowName) {\n      case 'host':\n      case 'connection':\n      case 'keep-alive':\n      case 'proxy-connection':\n      case 'transfer-encoding':\n      case 'upgrade':\n        return\n    }\n\n    // Should be in `pairs`\n    if (/^:/.test(lowName)) {\n      return\n    }\n\n    // Do not compress, or index Cookie field (for security reasons)\n    var neverIndex = lowName === 'cookie' || lowName === 'set-cookie'\n\n    var value = headers[name]\n    if (Array.isArray(value)) {\n      for (var i = 0; i < value.length; i++) {\n        pairs.push({\n          name: lowName,\n          value: value[i] + '',\n          neverIndex: neverIndex,\n          huffman: !neverIndex\n        })\n      }\n    } else {\n      pairs.push({\n        name: lowName,\n        value: value + '',\n        neverIndex: neverIndex,\n        huffman: !neverIndex\n      })\n    }\n  })\n\n  assert(this.compress !== null, 'Framer version not initialized')\n  debugExtra('compressing headers=%j', pairs)\n  this.compress.write([ pairs ], callback)\n}\n\nFramer.prototype._isDefaultPriority = function _isDefaultPriority (priority) {\n  if (!priority) { return true }\n\n  return !priority.parent &&\n         priority.weight === constants.DEFAULT &&\n         !priority.exclusive\n}\n\nFramer.prototype._defaultHeaders = function _defaultHeaders (frame, pairs) {\n  if (!frame.path) {\n    throw new Error('`path` is required frame argument')\n  }\n\n  pairs.push({\n    name: ':method',\n    value: frame.method || base.constants.DEFAULT_METHOD\n  })\n  pairs.push({ name: ':path', value: frame.path })\n  pairs.push({ name: ':scheme', value: frame.scheme || 'https' })\n  pairs.push({\n    name: ':authority',\n    value: frame.host ||\n           (frame.headers && frame.headers.host) ||\n           base.constants.DEFAULT_HOST\n  })\n}\n\nFramer.prototype._headersFrame = function _headersFrame (kind, frame, callback) {\n  var pairs = []\n\n  if (kind === 'request') {\n    this._defaultHeaders(frame, pairs)\n  } else if (kind === 'response') {\n    pairs.push({ name: ':status', value: (frame.status || 200) + '' })\n  }\n\n  var self = this\n  this._compressHeaders(frame.headers, pairs, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err)\n      } else {\n        return self.emit('error', err)\n      }\n    }\n\n    var reserve = 0\n\n    // If priority info is present, and the values are not default ones\n    // reserve space for the priority info and add PRIORITY flag\n    var priority = frame.priority\n    if (!self._isDefaultPriority(priority)) { reserve = 5 }\n\n    var flags = reserve === 0 ? 0 : constants.flags.PRIORITY\n\n    // Mostly for testing\n    if (frame.fin) {\n      flags |= constants.flags.END_STREAM\n    }\n\n    self._continuationFrame({\n      id: frame.id,\n      type: 'HEADERS',\n      flags: flags,\n      reserve: reserve,\n      chunks: chunks\n    }, function (buf) {\n      if (reserve === 0) {\n        return\n      }\n\n      buf.writeUInt32BE(((priority.exclusive ? 0x80000000 : 0) |\n                         priority.parent) >>> 0)\n      buf.writeUInt8((priority.weight | 0) - 1)\n    }, callback)\n  })\n}\n\nFramer.prototype.requestFrame = function requestFrame (frame, callback) {\n  return this._headersFrame('request', frame, callback)\n}\n\nFramer.prototype.responseFrame = function responseFrame (frame, callback) {\n  return this._headersFrame('response', frame, callback)\n}\n\nFramer.prototype.headersFrame = function headersFrame (frame, callback) {\n  return this._headersFrame('headers', frame, callback)\n}\n\nFramer.prototype.pushFrame = function pushFrame (frame, callback) {\n  var self = this\n\n  function compress (headers, pairs, callback) {\n    self._compressHeaders(headers, pairs, function (err, chunks) {\n      if (err) {\n        if (callback) {\n          return callback(err)\n        } else {\n          return self.emit('error', err)\n        }\n      }\n\n      callback(chunks)\n    })\n  }\n\n  function sendPromise (chunks) {\n    self._continuationFrame({\n      id: frame.id,\n      type: 'PUSH_PROMISE',\n      reserve: 4,\n      chunks: chunks\n    }, function (buf) {\n      buf.writeUInt32BE(frame.promisedId)\n    })\n  }\n\n  function sendResponse (chunks, callback) {\n    var priority = frame.priority\n    var isDefaultPriority = self._isDefaultPriority(priority)\n    var flags = isDefaultPriority ? 0 : constants.flags.PRIORITY\n\n    // Mostly for testing\n    if (frame.fin) {\n      flags |= constants.flags.END_STREAM\n    }\n\n    self._continuationFrame({\n      id: frame.promisedId,\n      type: 'HEADERS',\n      flags: flags,\n      reserve: isDefaultPriority ? 0 : 5,\n      chunks: chunks\n    }, function (buf) {\n      if (isDefaultPriority) {\n        return\n      }\n\n      buf.writeUInt32BE((priority.exclusive ? 0x80000000 : 0) |\n                        priority.parent)\n      buf.writeUInt8((priority.weight | 0) - 1)\n    }, callback)\n  }\n\n  this._checkPush(function (err) {\n    if (err) {\n      return callback(err)\n    }\n\n    var pairs = {\n      promise: [],\n      response: []\n    }\n\n    self._defaultHeaders(frame, pairs.promise)\n    pairs.response.push({ name: ':status', value: (frame.status || 200) + '' })\n\n    compress(frame.headers, pairs.promise, function (promiseChunks) {\n      sendPromise(promiseChunks)\n      if (frame.response === false) {\n        return callback(null)\n      }\n      compress(frame.response, pairs.response, function (responseChunks) {\n        sendResponse(responseChunks, callback)\n      })\n    })\n  })\n}\n\nFramer.prototype.priorityFrame = function priorityFrame (frame, callback) {\n  this._frame({\n    id: frame.id,\n    priority: false,\n    type: 'PRIORITY',\n    flags: 0\n  }, function (buf) {\n    var priority = frame.priority\n    buf.writeUInt32BE((priority.exclusive ? 0x80000000 : 0) |\n                      priority.parent)\n    buf.writeUInt8((priority.weight | 0) - 1)\n  }, callback)\n}\n\nFramer.prototype.dataFrame = function dataFrame (frame, callback) {\n  var frames = this._split({\n    reserve: 0,\n    chunks: [ frame.data ]\n  })\n\n  var fin = frame.fin ? constants.flags.END_STREAM : 0\n\n  var self = this\n  frames.forEach(function (subFrame, i) {\n    var isLast = i === frames.length - 1\n    var flags = 0\n    if (isLast) {\n      flags |= fin\n    }\n\n    self._frame({\n      id: frame.id,\n      priority: frame.priority,\n      type: 'DATA',\n      flags: flags\n    }, function (buf) {\n      buf.reserve(subFrame.size)\n      for (var i = 0; i < subFrame.chunks.length; i++) { buf.copyFrom(subFrame.chunks[i]) }\n    }, isLast ? callback : null)\n  })\n\n  // Empty DATA\n  if (frames.length === 0) {\n    this._frame({\n      id: frame.id,\n      priority: frame.priority,\n      type: 'DATA',\n      flags: fin\n    }, function (buf) {\n      // No-op\n    }, callback)\n  }\n}\n\nFramer.prototype.pingFrame = function pingFrame (frame, callback) {\n  this._frame({\n    id: 0,\n    type: 'PING',\n    flags: frame.ack ? constants.flags.ACK : 0\n  }, function (buf) {\n    buf.copyFrom(frame.opaque)\n  }, callback)\n}\n\nFramer.prototype.rstFrame = function rstFrame (frame, callback) {\n  this._frame({\n    id: frame.id,\n    type: 'RST_STREAM',\n    flags: 0\n  }, function (buf) {\n    buf.writeUInt32BE(constants.error[frame.code])\n  }, callback)\n}\n\nFramer.prototype.prefaceFrame = function prefaceFrame (callback) {\n  debug('preface')\n  this._resetTimeout()\n  this.schedule({\n    stream: 0,\n    priority: false,\n    chunks: [ constants.PREFACE_BUFFER ],\n    callback: callback\n  })\n}\n\nFramer.prototype.settingsFrame = function settingsFrame (options, callback) {\n  var key = JSON.stringify(options)\n\n  var settings = Framer.settingsCache[key]\n  if (settings) {\n    debug('cached settings')\n    this._resetTimeout()\n    this.schedule({\n      id: 0,\n      priority: false,\n      chunks: settings,\n      callback: callback\n    })\n    return\n  }\n\n  var params = []\n  for (var i = 0; i < constants.settingsIndex.length; i++) {\n    var name = constants.settingsIndex[i]\n    if (!name) {\n      continue\n    }\n\n    // value: Infinity\n    if (!isFinite(options[name])) {\n      continue\n    }\n\n    if (options[name] !== undefined) {\n      params.push({ key: i, value: options[name] })\n    }\n  }\n\n  var bodySize = params.length * 6\n\n  var chunks = this._frame({\n    id: 0,\n    type: 'SETTINGS',\n    flags: 0\n  }, function (buffer) {\n    buffer.reserve(bodySize)\n    for (var i = 0; i < params.length; i++) {\n      var param = params[i]\n\n      buffer.writeUInt16BE(param.key)\n      buffer.writeUInt32BE(param.value)\n    }\n  }, callback)\n\n  Framer.settingsCache[key] = chunks\n}\nFramer.settingsCache = {}\n\nFramer.prototype.ackSettingsFrame = function ackSettingsFrame (callback) {\n  /* var chunks = */ this._frame({\n    id: 0,\n    type: 'SETTINGS',\n    flags: constants.flags.ACK\n  }, function (buffer) {\n    // No-op\n  }, callback)\n}\n\nFramer.prototype.windowUpdateFrame = function windowUpdateFrame (frame,\n  callback) {\n  this._frame({\n    id: frame.id,\n    type: 'WINDOW_UPDATE',\n    flags: 0\n  }, function (buffer) {\n    buffer.reserve(4)\n    buffer.writeInt32BE(frame.delta)\n  }, callback)\n}\n\nFramer.prototype.goawayFrame = function goawayFrame (frame, callback) {\n  this._frame({\n    type: 'GOAWAY',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8)\n\n    // Last-good-stream-ID\n    buf.writeUInt32BE(frame.lastId & 0x7fffffff)\n    // Code\n    buf.writeUInt32BE(constants.goaway[frame.code])\n\n    // Extra debugging information\n    if (frame.extra) { buf.write(frame.extra) }\n  }, callback)\n}\n\nFramer.prototype.xForwardedFor = function xForwardedFor (frame, callback) {\n  this._frame({\n    type: 'X_FORWARDED_FOR',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.write(frame.host)\n  }, callback)\n}\n"]},"metadata":{},"sourceType":"script"}