{"ast":null,"code":"'use strict';\n\nvar transport = require('../../../spdy-transport');\n\nvar constants = require('./').constants;\n\nvar base = transport.protocol.base;\nvar utils = base.utils;\n\nvar assert = require('assert');\n\nvar util = require('util');\n\nvar Buffer = require('buffer').Buffer;\n\nvar WriteBuffer = require('wbuf');\n\nvar debug = require('debug')('spdy:framer');\n\nfunction Framer(options) {\n  base.Framer.call(this, options);\n}\n\nutil.inherits(Framer, base.Framer);\nmodule.exports = Framer;\n\nFramer.create = function create(options) {\n  return new Framer(options);\n};\n\nFramer.prototype.setMaxFrameSize = function setMaxFrameSize(size) {// http2-only\n};\n\nFramer.prototype.headersToDict = function headersToDict(headers, preprocess, callback) {\n  function stringify(value) {\n    if (value !== undefined) {\n      if (Array.isArray(value)) {\n        return value.join('\\x00');\n      } else if (typeof value === 'string') {\n        return value;\n      } else {\n        return value.toString();\n      }\n    } else {\n      return '';\n    }\n  } // Lower case of all headers keys\n\n\n  var loweredHeaders = {};\n  Object.keys(headers || {}).map(function (key) {\n    loweredHeaders[key.toLowerCase()] = headers[key];\n  }); // Allow outer code to add custom headers or remove something\n\n  if (preprocess) {\n    preprocess(loweredHeaders);\n  } // Transform object into kv pairs\n\n\n  var size = this.version === 2 ? 2 : 4;\n  var len = size;\n  var pairs = Object.keys(loweredHeaders).filter(function (key) {\n    var lkey = key.toLowerCase(); // Will be in `:host`\n\n    if (lkey === 'host' && this.version >= 3) {\n      return false;\n    }\n\n    return lkey !== 'connection' && lkey !== 'keep-alive' && lkey !== 'proxy-connection' && lkey !== 'transfer-encoding';\n  }, this).map(function (key) {\n    var klen = Buffer.byteLength(key);\n    var value = stringify(loweredHeaders[key]);\n    var vlen = Buffer.byteLength(value);\n    len += size * 2 + klen + vlen;\n    return [klen, key, vlen, value];\n  });\n  var block = new WriteBuffer();\n  block.reserve(len);\n\n  if (this.version === 2) {\n    block.writeUInt16BE(pairs.length);\n  } else {\n    block.writeUInt32BE(pairs.length);\n  }\n\n  pairs.forEach(function (pair) {\n    // Write key length\n    if (this.version === 2) {\n      block.writeUInt16BE(pair[0]);\n    } else {\n      block.writeUInt32BE(pair[0]);\n    } // Write key\n\n\n    block.write(pair[1]); // Write value length\n\n    if (this.version === 2) {\n      block.writeUInt16BE(pair[2]);\n    } else {\n      block.writeUInt32BE(pair[2]);\n    } // Write value\n\n\n    block.write(pair[3]);\n  }, this);\n  assert(this.compress !== null, 'Framer version not initialized');\n  this.compress.write(block.render(), callback);\n};\n\nFramer.prototype._frame = function _frame(frame, body, callback) {\n  if (!this.version) {\n    this.on('version', function () {\n      this._frame(frame, body, callback);\n    });\n    return;\n  }\n\n  debug('id=%d type=%s', frame.id, frame.type);\n  var buffer = new WriteBuffer();\n  buffer.writeUInt16BE(0x8000 | this.version);\n  buffer.writeUInt16BE(constants.frameType[frame.type]);\n  buffer.writeUInt8(frame.flags);\n  var len = buffer.skip(3);\n  body(buffer);\n  var frameSize = buffer.size - constants.FRAME_HEADER_SIZE;\n  len.writeUInt24BE(frameSize);\n  var chunks = buffer.render();\n  var toWrite = {\n    stream: frame.id,\n    priority: false,\n    chunks: chunks,\n    callback: callback\n  };\n\n  this._resetTimeout();\n\n  this.schedule(toWrite);\n  return chunks;\n};\n\nFramer.prototype._synFrame = function _synFrame(frame, callback) {\n  var self = this;\n\n  if (!frame.path) {\n    throw new Error('`path` is required frame argument');\n  }\n\n  function preprocess(headers) {\n    var method = frame.method || base.constants.DEFAULT_METHOD;\n    var version = frame.version || 'HTTP/1.1';\n    var scheme = frame.scheme || 'https';\n    var host = frame.host || frame.headers && frame.headers.host || base.constants.DEFAULT_HOST;\n\n    if (self.version === 2) {\n      headers.method = method;\n      headers.version = version;\n      headers.url = frame.path;\n      headers.scheme = scheme;\n      headers.host = host;\n\n      if (frame.status) {\n        headers.status = frame.status;\n      }\n    } else {\n      headers[':method'] = method;\n      headers[':version'] = version;\n      headers[':path'] = frame.path;\n      headers[':scheme'] = scheme;\n      headers[':host'] = host;\n\n      if (frame.status) {\n        headers[':status'] = frame.status;\n      }\n    }\n  }\n\n  this.headersToDict(frame.headers, preprocess, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err);\n      } else {\n        return self.emit('error', err);\n      }\n    }\n\n    self._frame({\n      type: 'SYN_STREAM',\n      id: frame.id,\n      flags: frame.fin ? constants.flags.FLAG_FIN : 0\n    }, function (buf) {\n      buf.reserve(10);\n      buf.writeUInt32BE(frame.id & 0x7fffffff);\n      buf.writeUInt32BE(frame.associated & 0x7fffffff);\n      var weight = frame.priority && frame.priority.weight || constants.DEFAULT_WEIGHT; // We only have 3 bits for priority in SPDY, try to fit it into this\n\n      var priority = utils.weightToPriority(weight);\n      buf.writeUInt8(priority << 5); // CREDENTIALS slot\n\n      buf.writeUInt8(0);\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i]);\n      }\n    }, callback);\n  });\n};\n\nFramer.prototype.requestFrame = function requestFrame(frame, callback) {\n  this._synFrame({\n    id: frame.id,\n    fin: frame.fin,\n    associated: 0,\n    method: frame.method,\n    version: frame.version,\n    scheme: frame.scheme,\n    host: frame.host,\n    path: frame.path,\n    priority: frame.priority,\n    headers: frame.headers\n  }, callback);\n};\n\nFramer.prototype.responseFrame = function responseFrame(frame, callback) {\n  var self = this;\n  var reason = frame.reason;\n\n  if (!reason) {\n    reason = constants.statusReason[frame.status];\n  }\n\n  function preprocess(headers) {\n    if (self.version === 2) {\n      headers.status = frame.status + ' ' + reason;\n      headers.version = 'HTTP/1.1';\n    } else {\n      headers[':status'] = frame.status + ' ' + reason;\n      headers[':version'] = 'HTTP/1.1';\n    }\n  }\n\n  this.headersToDict(frame.headers, preprocess, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err);\n      } else {\n        return self.emit('error', err);\n      }\n    }\n\n    self._frame({\n      type: 'SYN_REPLY',\n      id: frame.id,\n      flags: 0\n    }, function (buf) {\n      buf.reserve(self.version === 2 ? 6 : 4);\n      buf.writeUInt32BE(frame.id & 0x7fffffff); // Unused data\n\n      if (self.version === 2) {\n        buf.writeUInt16BE(0);\n      }\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i]);\n      }\n    }, callback);\n  });\n};\n\nFramer.prototype.pushFrame = function pushFrame(frame, callback) {\n  var self = this;\n\n  this._checkPush(function (err) {\n    if (err) {\n      return callback(err);\n    }\n\n    self._synFrame({\n      id: frame.promisedId,\n      associated: frame.id,\n      method: frame.method,\n      status: frame.status || 200,\n      version: frame.version,\n      scheme: frame.scheme,\n      host: frame.host,\n      path: frame.path,\n      priority: frame.priority,\n      // Merge everything together, there is no difference in SPDY protocol\n      headers: Object.assign(Object.assign({}, frame.headers), frame.response)\n    }, callback);\n  });\n};\n\nFramer.prototype.headersFrame = function headersFrame(frame, callback) {\n  var self = this;\n  this.headersToDict(frame.headers, null, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err);\n      } else {\n        return self.emit('error', err);\n      }\n    }\n\n    self._frame({\n      type: 'HEADERS',\n      id: frame.id,\n      priority: false,\n      flags: 0\n    }, function (buf) {\n      buf.reserve(4 + (self.version === 2 ? 2 : 0));\n      buf.writeUInt32BE(frame.id & 0x7fffffff); // Unused data\n\n      if (self.version === 2) {\n        buf.writeUInt16BE(0);\n      }\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i]);\n      }\n    }, callback);\n  });\n};\n\nFramer.prototype.dataFrame = function dataFrame(frame, callback) {\n  if (!this.version) {\n    return this.on('version', function () {\n      this.dataFrame(frame, callback);\n    });\n  }\n\n  debug('id=%d type=DATA', frame.id);\n  var buffer = new WriteBuffer();\n  buffer.reserve(8 + frame.data.length);\n  buffer.writeUInt32BE(frame.id & 0x7fffffff);\n  buffer.writeUInt8(frame.fin ? 0x01 : 0x0);\n  buffer.writeUInt24BE(frame.data.length);\n  buffer.copyFrom(frame.data);\n  var chunks = buffer.render();\n  var toWrite = {\n    stream: frame.id,\n    priority: frame.priority,\n    chunks: chunks,\n    callback: callback\n  };\n  var self = this;\n\n  this._resetTimeout();\n\n  var bypass = this.version < 3.1;\n  this.window.send.update(-frame.data.length, bypass ? undefined : function () {\n    self._resetTimeout();\n\n    self.schedule(toWrite);\n  });\n\n  if (bypass) {\n    this._resetTimeout();\n\n    this.schedule(toWrite);\n  }\n};\n\nFramer.prototype.pingFrame = function pingFrame(frame, callback) {\n  this._frame({\n    type: 'PING',\n    id: 0,\n    flags: 0\n  }, function (buf, callback) {\n    buf.reserve(4);\n    var opaque = frame.opaque;\n    buf.writeUInt32BE(opaque.readUInt32BE(opaque.length - 4, true));\n  }, callback);\n};\n\nFramer.prototype.rstFrame = function rstFrame(frame, callback) {\n  this._frame({\n    type: 'RST_STREAM',\n    id: frame.id,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8); // Stream ID\n\n    buf.writeUInt32BE(frame.id & 0x7fffffff); // Status Code\n\n    buf.writeUInt32BE(constants.error[frame.code]); // Extra debugging information\n\n    if (frame.extra) {\n      buf.write(frame.extra);\n    }\n  }, callback);\n};\n\nFramer.prototype.prefaceFrame = function prefaceFrame() {};\n\nFramer.prototype.settingsFrame = function settingsFrame(options, callback) {\n  var self = this;\n  var key = this.version + '/' + JSON.stringify(options);\n  var settings = Framer.settingsCache[key];\n\n  if (settings) {\n    debug('cached settings');\n\n    this._resetTimeout();\n\n    this.schedule({\n      stream: 0,\n      priority: false,\n      chunks: settings,\n      callback: callback\n    });\n    return;\n  }\n\n  var params = [];\n\n  for (var i = 0; i < constants.settingsIndex.length; i++) {\n    var name = constants.settingsIndex[i];\n\n    if (!name) {\n      continue;\n    } // value: Infinity\n\n\n    if (!isFinite(options[name])) {\n      continue;\n    }\n\n    if (options[name] !== undefined) {\n      params.push({\n        key: i,\n        value: options[name]\n      });\n    }\n  }\n\n  var frame = this._frame({\n    type: 'SETTINGS',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(4 + 8 * params.length); // Count of entries\n\n    buf.writeUInt32BE(params.length);\n    params.forEach(function (param) {\n      var flag = constants.settings.FLAG_SETTINGS_PERSIST_VALUE << 24;\n\n      if (self.version === 2) {\n        buf.writeUInt32LE(flag | param.key);\n      } else {\n        buf.writeUInt32BE(flag | param.key);\n      }\n\n      buf.writeUInt32BE(param.value & 0x7fffffff);\n    });\n  }, callback);\n\n  Framer.settingsCache[key] = frame;\n};\n\nFramer.settingsCache = {};\n\nFramer.prototype.ackSettingsFrame = function ackSettingsFrame(callback) {\n  if (callback) {\n    process.nextTick(callback);\n  }\n};\n\nFramer.prototype.windowUpdateFrame = function windowUpdateFrame(frame, callback) {\n  this._frame({\n    type: 'WINDOW_UPDATE',\n    id: frame.id,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8); // ID\n\n    buf.writeUInt32BE(frame.id & 0x7fffffff); // Delta\n\n    buf.writeInt32BE(frame.delta);\n  }, callback);\n};\n\nFramer.prototype.goawayFrame = function goawayFrame(frame, callback) {\n  this._frame({\n    type: 'GOAWAY',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8); // Last-good-stream-ID\n\n    buf.writeUInt32BE(frame.lastId & 0x7fffffff); // Status\n\n    buf.writeUInt32BE(constants.goaway[frame.code]);\n  }, callback);\n};\n\nFramer.prototype.priorityFrame = function priorityFrame(frame, callback) {\n  // No such thing in SPDY\n  if (callback) {\n    process.nextTick(callback);\n  }\n};\n\nFramer.prototype.xForwardedFor = function xForwardedFor(frame, callback) {\n  this._frame({\n    type: 'X_FORWARDED_FOR',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.writeUInt32BE(Buffer.byteLength(frame.host));\n    buf.write(frame.host);\n  }, callback);\n};","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/spdy-transport/lib/spdy-transport/protocol/spdy/framer.js"],"names":["transport","require","constants","base","protocol","utils","assert","util","Buffer","WriteBuffer","debug","Framer","options","call","inherits","module","exports","create","prototype","setMaxFrameSize","size","headersToDict","headers","preprocess","callback","stringify","value","undefined","Array","isArray","join","toString","loweredHeaders","Object","keys","map","key","toLowerCase","version","len","pairs","filter","lkey","klen","byteLength","vlen","block","reserve","writeUInt16BE","length","writeUInt32BE","forEach","pair","write","compress","render","_frame","frame","body","on","id","type","buffer","frameType","writeUInt8","flags","skip","frameSize","FRAME_HEADER_SIZE","writeUInt24BE","chunks","toWrite","stream","priority","_resetTimeout","schedule","_synFrame","self","path","Error","method","DEFAULT_METHOD","scheme","host","DEFAULT_HOST","url","status","err","emit","fin","FLAG_FIN","buf","associated","weight","DEFAULT_WEIGHT","weightToPriority","i","copyFrom","requestFrame","responseFrame","reason","statusReason","pushFrame","_checkPush","promisedId","assign","response","headersFrame","dataFrame","data","bypass","window","send","update","pingFrame","opaque","readUInt32BE","rstFrame","error","code","extra","prefaceFrame","settingsFrame","JSON","settings","settingsCache","params","settingsIndex","name","isFinite","push","param","flag","FLAG_SETTINGS_PERSIST_VALUE","writeUInt32LE","ackSettingsFrame","process","nextTick","windowUpdateFrame","writeInt32BE","delta","goawayFrame","lastId","goaway","priorityFrame","xForwardedFor"],"mappings":"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","sourcesContent":["'use strict'\n\nvar transport = require('../../../spdy-transport')\nvar constants = require('./').constants\nvar base = transport.protocol.base\nvar utils = base.utils\n\nvar assert = require('assert')\nvar util = require('util')\nvar Buffer = require('buffer').Buffer\nvar WriteBuffer = require('wbuf')\n\nvar debug = require('debug')('spdy:framer')\n\nfunction Framer (options) {\n  base.Framer.call(this, options)\n}\nutil.inherits(Framer, base.Framer)\nmodule.exports = Framer\n\nFramer.create = function create (options) {\n  return new Framer(options)\n}\n\nFramer.prototype.setMaxFrameSize = function setMaxFrameSize (size) {\n  // http2-only\n}\n\nFramer.prototype.headersToDict = function headersToDict (headers,\n  preprocess,\n  callback) {\n  function stringify (value) {\n    if (value !== undefined) {\n      if (Array.isArray(value)) {\n        return value.join('\\x00')\n      } else if (typeof value === 'string') {\n        return value\n      } else {\n        return value.toString()\n      }\n    } else {\n      return ''\n    }\n  }\n\n  // Lower case of all headers keys\n  var loweredHeaders = {}\n  Object.keys(headers || {}).map(function (key) {\n    loweredHeaders[key.toLowerCase()] = headers[key]\n  })\n\n  // Allow outer code to add custom headers or remove something\n  if (preprocess) { preprocess(loweredHeaders) }\n\n  // Transform object into kv pairs\n  var size = this.version === 2 ? 2 : 4\n  var len = size\n  var pairs = Object.keys(loweredHeaders).filter(function (key) {\n    var lkey = key.toLowerCase()\n\n    // Will be in `:host`\n    if (lkey === 'host' && this.version >= 3) {\n      return false\n    }\n\n    return lkey !== 'connection' && lkey !== 'keep-alive' &&\n           lkey !== 'proxy-connection' && lkey !== 'transfer-encoding'\n  }, this).map(function (key) {\n    var klen = Buffer.byteLength(key)\n    var value = stringify(loweredHeaders[key])\n    var vlen = Buffer.byteLength(value)\n\n    len += size * 2 + klen + vlen\n    return [klen, key, vlen, value]\n  })\n\n  var block = new WriteBuffer()\n  block.reserve(len)\n\n  if (this.version === 2) {\n    block.writeUInt16BE(pairs.length)\n  } else {\n    block.writeUInt32BE(pairs.length)\n  }\n\n  pairs.forEach(function (pair) {\n    // Write key length\n    if (this.version === 2) {\n      block.writeUInt16BE(pair[0])\n    } else {\n      block.writeUInt32BE(pair[0])\n    }\n\n    // Write key\n    block.write(pair[1])\n\n    // Write value length\n    if (this.version === 2) {\n      block.writeUInt16BE(pair[2])\n    } else {\n      block.writeUInt32BE(pair[2])\n    }\n    // Write value\n    block.write(pair[3])\n  }, this)\n\n  assert(this.compress !== null, 'Framer version not initialized')\n  this.compress.write(block.render(), callback)\n}\n\nFramer.prototype._frame = function _frame (frame, body, callback) {\n  if (!this.version) {\n    this.on('version', function () {\n      this._frame(frame, body, callback)\n    })\n    return\n  }\n\n  debug('id=%d type=%s', frame.id, frame.type)\n\n  var buffer = new WriteBuffer()\n\n  buffer.writeUInt16BE(0x8000 | this.version)\n  buffer.writeUInt16BE(constants.frameType[frame.type])\n  buffer.writeUInt8(frame.flags)\n  var len = buffer.skip(3)\n\n  body(buffer)\n\n  var frameSize = buffer.size - constants.FRAME_HEADER_SIZE\n  len.writeUInt24BE(frameSize)\n\n  var chunks = buffer.render()\n  var toWrite = {\n    stream: frame.id,\n    priority: false,\n    chunks: chunks,\n    callback: callback\n  }\n\n  this._resetTimeout()\n  this.schedule(toWrite)\n\n  return chunks\n}\n\nFramer.prototype._synFrame = function _synFrame (frame, callback) {\n  var self = this\n\n  if (!frame.path) {\n    throw new Error('`path` is required frame argument')\n  }\n\n  function preprocess (headers) {\n    var method = frame.method || base.constants.DEFAULT_METHOD\n    var version = frame.version || 'HTTP/1.1'\n    var scheme = frame.scheme || 'https'\n    var host = frame.host ||\n               (frame.headers && frame.headers.host) ||\n               base.constants.DEFAULT_HOST\n\n    if (self.version === 2) {\n      headers.method = method\n      headers.version = version\n      headers.url = frame.path\n      headers.scheme = scheme\n      headers.host = host\n      if (frame.status) {\n        headers.status = frame.status\n      }\n    } else {\n      headers[':method'] = method\n      headers[':version'] = version\n      headers[':path'] = frame.path\n      headers[':scheme'] = scheme\n      headers[':host'] = host\n      if (frame.status) { headers[':status'] = frame.status }\n    }\n  }\n\n  this.headersToDict(frame.headers, preprocess, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err)\n      } else {\n        return self.emit('error', err)\n      }\n    }\n\n    self._frame({\n      type: 'SYN_STREAM',\n      id: frame.id,\n      flags: frame.fin ? constants.flags.FLAG_FIN : 0\n    }, function (buf) {\n      buf.reserve(10)\n\n      buf.writeUInt32BE(frame.id & 0x7fffffff)\n      buf.writeUInt32BE(frame.associated & 0x7fffffff)\n\n      var weight = (frame.priority && frame.priority.weight) ||\n                   constants.DEFAULT_WEIGHT\n\n      // We only have 3 bits for priority in SPDY, try to fit it into this\n      var priority = utils.weightToPriority(weight)\n      buf.writeUInt8(priority << 5)\n\n      // CREDENTIALS slot\n      buf.writeUInt8(0)\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i])\n      }\n    }, callback)\n  })\n}\n\nFramer.prototype.requestFrame = function requestFrame (frame, callback) {\n  this._synFrame({\n    id: frame.id,\n    fin: frame.fin,\n    associated: 0,\n    method: frame.method,\n    version: frame.version,\n    scheme: frame.scheme,\n    host: frame.host,\n    path: frame.path,\n    priority: frame.priority,\n    headers: frame.headers\n  }, callback)\n}\n\nFramer.prototype.responseFrame = function responseFrame (frame, callback) {\n  var self = this\n\n  var reason = frame.reason\n  if (!reason) {\n    reason = constants.statusReason[frame.status]\n  }\n\n  function preprocess (headers) {\n    if (self.version === 2) {\n      headers.status = frame.status + ' ' + reason\n      headers.version = 'HTTP/1.1'\n    } else {\n      headers[':status'] = frame.status + ' ' + reason\n      headers[':version'] = 'HTTP/1.1'\n    }\n  }\n\n  this.headersToDict(frame.headers, preprocess, function (err, chunks) {\n    if (err) {\n      if (callback) {\n        return callback(err)\n      } else {\n        return self.emit('error', err)\n      }\n    }\n\n    self._frame({\n      type: 'SYN_REPLY',\n      id: frame.id,\n      flags: 0\n    }, function (buf) {\n      buf.reserve(self.version === 2 ? 6 : 4)\n\n      buf.writeUInt32BE(frame.id & 0x7fffffff)\n\n      // Unused data\n      if (self.version === 2) {\n        buf.writeUInt16BE(0)\n      }\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i])\n      }\n    }, callback)\n  })\n}\n\nFramer.prototype.pushFrame = function pushFrame (frame, callback) {\n  var self = this\n\n  this._checkPush(function (err) {\n    if (err) { return callback(err) }\n\n    self._synFrame({\n      id: frame.promisedId,\n      associated: frame.id,\n      method: frame.method,\n      status: frame.status || 200,\n      version: frame.version,\n      scheme: frame.scheme,\n      host: frame.host,\n      path: frame.path,\n      priority: frame.priority,\n\n      // Merge everything together, there is no difference in SPDY protocol\n      headers: Object.assign(Object.assign({}, frame.headers), frame.response)\n    }, callback)\n  })\n}\n\nFramer.prototype.headersFrame = function headersFrame (frame, callback) {\n  var self = this\n\n  this.headersToDict(frame.headers, null, function (err, chunks) {\n    if (err) {\n      if (callback) { return callback(err) } else {\n        return self.emit('error', err)\n      }\n    }\n\n    self._frame({\n      type: 'HEADERS',\n      id: frame.id,\n      priority: false,\n      flags: 0\n    }, function (buf) {\n      buf.reserve(4 + (self.version === 2 ? 2 : 0))\n      buf.writeUInt32BE(frame.id & 0x7fffffff)\n\n      // Unused data\n      if (self.version === 2) { buf.writeUInt16BE(0) }\n\n      for (var i = 0; i < chunks.length; i++) {\n        buf.copyFrom(chunks[i])\n      }\n    }, callback)\n  })\n}\n\nFramer.prototype.dataFrame = function dataFrame (frame, callback) {\n  if (!this.version) {\n    return this.on('version', function () {\n      this.dataFrame(frame, callback)\n    })\n  }\n\n  debug('id=%d type=DATA', frame.id)\n\n  var buffer = new WriteBuffer()\n  buffer.reserve(8 + frame.data.length)\n\n  buffer.writeUInt32BE(frame.id & 0x7fffffff)\n  buffer.writeUInt8(frame.fin ? 0x01 : 0x0)\n  buffer.writeUInt24BE(frame.data.length)\n  buffer.copyFrom(frame.data)\n\n  var chunks = buffer.render()\n  var toWrite = {\n    stream: frame.id,\n    priority: frame.priority,\n    chunks: chunks,\n    callback: callback\n  }\n\n  var self = this\n  this._resetTimeout()\n\n  var bypass = this.version < 3.1\n  this.window.send.update(-frame.data.length, bypass ? undefined : function () {\n    self._resetTimeout()\n    self.schedule(toWrite)\n  })\n\n  if (bypass) {\n    this._resetTimeout()\n    this.schedule(toWrite)\n  }\n}\n\nFramer.prototype.pingFrame = function pingFrame (frame, callback) {\n  this._frame({\n    type: 'PING',\n    id: 0,\n    flags: 0\n  }, function (buf, callback) {\n    buf.reserve(4)\n\n    var opaque = frame.opaque\n    buf.writeUInt32BE(opaque.readUInt32BE(opaque.length - 4, true))\n  }, callback)\n}\n\nFramer.prototype.rstFrame = function rstFrame (frame, callback) {\n  this._frame({\n    type: 'RST_STREAM',\n    id: frame.id,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8)\n\n    // Stream ID\n    buf.writeUInt32BE(frame.id & 0x7fffffff)\n    // Status Code\n    buf.writeUInt32BE(constants.error[frame.code])\n\n    // Extra debugging information\n    if (frame.extra) {\n      buf.write(frame.extra)\n    }\n  }, callback)\n}\n\nFramer.prototype.prefaceFrame = function prefaceFrame () {\n}\n\nFramer.prototype.settingsFrame = function settingsFrame (options, callback) {\n  var self = this\n\n  var key = this.version + '/' + JSON.stringify(options)\n\n  var settings = Framer.settingsCache[key]\n  if (settings) {\n    debug('cached settings')\n    this._resetTimeout()\n    this.schedule({\n      stream: 0,\n      priority: false,\n      chunks: settings,\n      callback: callback\n    })\n    return\n  }\n\n  var params = []\n  for (var i = 0; i < constants.settingsIndex.length; i++) {\n    var name = constants.settingsIndex[i]\n    if (!name) { continue }\n\n    // value: Infinity\n    if (!isFinite(options[name])) {\n      continue\n    }\n\n    if (options[name] !== undefined) {\n      params.push({ key: i, value: options[name] })\n    }\n  }\n\n  var frame = this._frame({\n    type: 'SETTINGS',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(4 + 8 * params.length)\n\n    // Count of entries\n    buf.writeUInt32BE(params.length)\n\n    params.forEach(function (param) {\n      var flag = constants.settings.FLAG_SETTINGS_PERSIST_VALUE << 24\n\n      if (self.version === 2) {\n        buf.writeUInt32LE(flag | param.key)\n      } else { buf.writeUInt32BE(flag | param.key) }\n      buf.writeUInt32BE(param.value & 0x7fffffff)\n    })\n  }, callback)\n\n  Framer.settingsCache[key] = frame\n}\nFramer.settingsCache = {}\n\nFramer.prototype.ackSettingsFrame = function ackSettingsFrame (callback) {\n  if (callback) {\n    process.nextTick(callback)\n  }\n}\n\nFramer.prototype.windowUpdateFrame = function windowUpdateFrame (frame,\n  callback) {\n  this._frame({\n    type: 'WINDOW_UPDATE',\n    id: frame.id,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8)\n\n    // ID\n    buf.writeUInt32BE(frame.id & 0x7fffffff)\n\n    // Delta\n    buf.writeInt32BE(frame.delta)\n  }, callback)\n}\n\nFramer.prototype.goawayFrame = function goawayFrame (frame, callback) {\n  this._frame({\n    type: 'GOAWAY',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.reserve(8)\n\n    // Last-good-stream-ID\n    buf.writeUInt32BE(frame.lastId & 0x7fffffff)\n    // Status\n    buf.writeUInt32BE(constants.goaway[frame.code])\n  }, callback)\n}\n\nFramer.prototype.priorityFrame = function priorityFrame (frame, callback) {\n  // No such thing in SPDY\n  if (callback) {\n    process.nextTick(callback)\n  }\n}\n\nFramer.prototype.xForwardedFor = function xForwardedFor (frame, callback) {\n  this._frame({\n    type: 'X_FORWARDED_FOR',\n    id: 0,\n    flags: 0\n  }, function (buf) {\n    buf.writeUInt32BE(Buffer.byteLength(frame.host))\n    buf.write(frame.host)\n  }, callback)\n}\n"]},"metadata":{},"sourceType":"script"}