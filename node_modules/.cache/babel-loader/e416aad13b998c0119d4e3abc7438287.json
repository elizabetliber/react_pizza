{"ast":null,"code":"'use strict';\n\nvar assert = require('assert');\n\nvar http = require('http');\n\nvar https = require('https');\n\nvar net = require('net');\n\nvar util = require('util');\n\nvar transport = require('spdy-transport');\n\nvar debug = require('debug')('spdy:client'); // Node.js 0.10 and 0.12 support\n\n\nObject.assign = process.versions.modules >= 46 ? Object.assign // eslint-disable-next-line\n: util._extend;\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar spdy = require('../spdy');\n\nvar mode = /^v0\\.8\\./.test(process.version) ? 'rusty' : /^v0\\.(9|10)\\./.test(process.version) ? 'old' : /^v0\\.12\\./.test(process.version) ? 'normal' : 'modern';\nvar proto = {};\n\nfunction instantiate(base) {\n  function Agent(options) {\n    this._init(base, options);\n  }\n\n  util.inherits(Agent, base);\n\n  Agent.create = function create(options) {\n    return new Agent(options);\n  };\n\n  Object.keys(proto).forEach(function (key) {\n    Agent.prototype[key] = proto[key];\n  });\n  return Agent;\n}\n\nproto._init = function _init(base, options) {\n  base.call(this, options);\n  var state = {};\n  this._spdyState = state;\n  state.host = options.host;\n  state.options = options.spdy || {};\n  state.secure = this instanceof https.Agent;\n  state.fallback = false;\n  state.createSocket = this._getCreateSocket();\n  state.socket = null;\n  state.connection = null; // No chunked encoding\n\n  this.keepAlive = false;\n  var self = this;\n\n  this._connect(options, function (err, connection) {\n    if (err) {\n      return self.emit('error', err);\n    }\n\n    state.connection = connection;\n    self.emit('_connect');\n  });\n};\n\nproto._getCreateSocket = function _getCreateSocket() {\n  // Find super's `createSocket` method\n  var createSocket;\n  var cons = this.constructor.super_;\n\n  do {\n    createSocket = cons.prototype.createSocket;\n\n    if (cons.super_ === EventEmitter || !cons.super_) {\n      break;\n    }\n\n    cons = cons.super_;\n  } while (!createSocket);\n\n  if (!createSocket) {\n    createSocket = http.Agent.prototype.createSocket;\n  }\n\n  assert(createSocket, '.createSocket() method not found');\n  return createSocket;\n};\n\nproto._connect = function _connect(options, callback) {\n  var self = this;\n  var state = this._spdyState;\n  var protocols = state.options.protocols || ['h2', 'spdy/3.1', 'spdy/3', 'spdy/2', 'http/1.1', 'http/1.0']; // TODO(indutny): reconnect automatically?\n\n  var socket = this.createConnection(Object.assign({\n    NPNProtocols: protocols,\n    ALPNProtocols: protocols,\n    servername: options.servername || options.host\n  }, options));\n  state.socket = socket;\n  socket.setNoDelay(true);\n\n  function onError(err) {\n    return callback(err);\n  }\n\n  socket.on('error', onError);\n  socket.on(state.secure ? 'secureConnect' : 'connect', function () {\n    socket.removeListener('error', onError);\n    var protocol;\n\n    if (state.secure) {\n      protocol = socket.npnProtocol || socket.alpnProtocol || state.options.protocol;\n    } else {\n      protocol = state.options.protocol;\n    } // HTTP server - kill socket and switch to the fallback mode\n\n\n    if (!protocol || protocol === 'http/1.1' || protocol === 'http/1.0') {\n      debug('activating fallback');\n      socket.destroy();\n      state.fallback = true;\n      return;\n    }\n\n    debug('connected protocol=%j', protocol);\n    var connection = transport.connection.create(socket, Object.assign({\n      protocol: /spdy/.test(protocol) ? 'spdy' : 'http2',\n      isServer: false\n    }, state.options.connection || {})); // Pass connection level errors are passed to the agent.\n\n    connection.on('error', function (err) {\n      self.emit('error', err);\n    }); // Set version when we are certain\n\n    if (protocol === 'h2') {\n      connection.start(4);\n    } else if (protocol === 'spdy/3.1') {\n      connection.start(3.1);\n    } else if (protocol === 'spdy/3') {\n      connection.start(3);\n    } else if (protocol === 'spdy/2') {\n      connection.start(2);\n    } else {\n      socket.destroy();\n      callback(new Error('Unexpected protocol: ' + protocol));\n      return;\n    }\n\n    if (state.options['x-forwarded-for'] !== undefined) {\n      connection.sendXForwardedFor(state.options['x-forwarded-for']);\n    }\n\n    callback(null, connection);\n  });\n};\n\nproto._createSocket = function _createSocket(req, options, callback) {\n  var state = this._spdyState;\n\n  if (state.fallback) {\n    return state.createSocket(req, options);\n  }\n\n  var handle = spdy.handle.create(null, null, state.socket);\n  var socketOptions = {\n    handle: handle,\n    allowHalfOpen: true\n  };\n  var socket;\n\n  if (state.secure) {\n    socket = new spdy.Socket(state.socket, socketOptions);\n  } else {\n    socket = new net.Socket(socketOptions);\n  }\n\n  handle.assignSocket(socket);\n  handle.assignClientRequest(req); // Create stream only once `req.end()` is called\n\n  var self = this;\n  handle.once('needStream', function () {\n    if (state.connection === null) {\n      self.once('_connect', function () {\n        handle.setStream(self._createStream(req, handle));\n      });\n    } else {\n      handle.setStream(self._createStream(req, handle));\n    }\n  }); // Yes, it is in reverse\n\n  req.on('response', function (res) {\n    handle.assignRequest(res);\n  });\n  handle.assignResponse(req); // Handle PUSH\n\n  req.addListener('newListener', spdy.request.onNewListener); // For v0.8\n\n  socket.readable = true;\n  socket.writable = true;\n\n  if (callback) {\n    return callback(null, socket);\n  }\n\n  return socket;\n};\n\nif (mode === 'modern' || mode === 'normal') {\n  proto.createSocket = proto._createSocket;\n} else {\n  proto.createSocket = function createSocket(name, host, port, addr, req) {\n    var state = this._spdyState;\n\n    if (state.fallback) {\n      return state.createSocket(name, host, port, addr, req);\n    }\n\n    return this._createSocket(req, {\n      host: host,\n      port: port\n    });\n  };\n}\n\nproto._createStream = function _createStream(req, handle) {\n  var state = this._spdyState;\n  var self = this;\n  return state.connection.reserveStream({\n    method: req.method,\n    path: req.path,\n    headers: req._headers,\n    host: state.host\n  }, function (err, stream) {\n    if (err) {\n      return self.emit('error', err);\n    }\n\n    stream.on('response', function (status, headers) {\n      handle.emitResponse(status, headers);\n    });\n  });\n}; // Public APIs\n\n\nproto.close = function close(callback) {\n  var state = this._spdyState;\n\n  if (state.connection === null) {\n    this.once('_connect', function () {\n      this.close(callback);\n    });\n    return;\n  }\n\n  state.connection.end(callback);\n};\n\nexports.Agent = instantiate(https.Agent);\nexports.PlainAgent = instantiate(http.Agent);\n\nexports.create = function create(base, options) {\n  if (typeof base === 'object') {\n    options = base;\n    base = null;\n  }\n\n  if (base) {\n    return instantiate(base).create(options);\n  }\n\n  if (options.spdy && options.spdy.plain) {\n    return exports.PlainAgent.create(options);\n  } else {\n    return exports.Agent.create(options);\n  }\n};","map":{"version":3,"sources":["/home/lisa/VSProjects/react-pizza/react_pizza/node_modules/spdy/lib/spdy/agent.js"],"names":["assert","require","http","https","net","util","transport","debug","Object","assign","process","versions","modules","_extend","EventEmitter","spdy","mode","test","version","proto","instantiate","base","Agent","options","_init","inherits","create","keys","forEach","key","prototype","call","state","_spdyState","host","secure","fallback","createSocket","_getCreateSocket","socket","connection","keepAlive","self","_connect","err","emit","cons","constructor","super_","callback","protocols","createConnection","NPNProtocols","ALPNProtocols","servername","setNoDelay","onError","on","removeListener","protocol","npnProtocol","alpnProtocol","destroy","isServer","start","Error","undefined","sendXForwardedFor","_createSocket","req","handle","socketOptions","allowHalfOpen","Socket","assignSocket","assignClientRequest","once","setStream","_createStream","res","assignRequest","assignResponse","addListener","request","onNewListener","readable","writable","name","port","addr","reserveStream","method","path","headers","_headers","stream","status","emitResponse","close","end","exports","PlainAgent","plain"],"mappings":"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","sourcesContent":["'use strict'\n\nvar assert = require('assert')\nvar http = require('http')\nvar https = require('https')\nvar net = require('net')\nvar util = require('util')\nvar transport = require('spdy-transport')\nvar debug = require('debug')('spdy:client')\n\n// Node.js 0.10 and 0.12 support\nObject.assign = process.versions.modules >= 46\n  ? Object.assign // eslint-disable-next-line\n  : util._extend\n\nvar EventEmitter = require('events').EventEmitter\n\nvar spdy = require('../spdy')\n\nvar mode = /^v0\\.8\\./.test(process.version)\n  ? 'rusty'\n  : /^v0\\.(9|10)\\./.test(process.version)\n    ? 'old'\n    : /^v0\\.12\\./.test(process.version)\n      ? 'normal'\n      : 'modern'\n\nvar proto = {}\n\nfunction instantiate (base) {\n  function Agent (options) {\n    this._init(base, options)\n  }\n  util.inherits(Agent, base)\n\n  Agent.create = function create (options) {\n    return new Agent(options)\n  }\n\n  Object.keys(proto).forEach(function (key) {\n    Agent.prototype[key] = proto[key]\n  })\n\n  return Agent\n}\n\nproto._init = function _init (base, options) {\n  base.call(this, options)\n\n  var state = {}\n  this._spdyState = state\n\n  state.host = options.host\n  state.options = options.spdy || {}\n  state.secure = this instanceof https.Agent\n  state.fallback = false\n  state.createSocket = this._getCreateSocket()\n  state.socket = null\n  state.connection = null\n\n  // No chunked encoding\n  this.keepAlive = false\n\n  var self = this\n  this._connect(options, function (err, connection) {\n    if (err) {\n      return self.emit('error', err)\n    }\n\n    state.connection = connection\n    self.emit('_connect')\n  })\n}\n\nproto._getCreateSocket = function _getCreateSocket () {\n  // Find super's `createSocket` method\n  var createSocket\n  var cons = this.constructor.super_\n  do {\n    createSocket = cons.prototype.createSocket\n\n    if (cons.super_ === EventEmitter || !cons.super_) {\n      break\n    }\n    cons = cons.super_\n  } while (!createSocket)\n  if (!createSocket) {\n    createSocket = http.Agent.prototype.createSocket\n  }\n\n  assert(createSocket, '.createSocket() method not found')\n\n  return createSocket\n}\n\nproto._connect = function _connect (options, callback) {\n  var self = this\n  var state = this._spdyState\n\n  var protocols = state.options.protocols || [\n    'h2',\n    'spdy/3.1', 'spdy/3', 'spdy/2',\n    'http/1.1', 'http/1.0'\n  ]\n\n  // TODO(indutny): reconnect automatically?\n  var socket = this.createConnection(Object.assign({\n    NPNProtocols: protocols,\n    ALPNProtocols: protocols,\n    servername: options.servername || options.host\n  }, options))\n  state.socket = socket\n\n  socket.setNoDelay(true)\n\n  function onError (err) {\n    return callback(err)\n  }\n  socket.on('error', onError)\n\n  socket.on(state.secure ? 'secureConnect' : 'connect', function () {\n    socket.removeListener('error', onError)\n\n    var protocol\n    if (state.secure) {\n      protocol = socket.npnProtocol ||\n                 socket.alpnProtocol ||\n                 state.options.protocol\n    } else {\n      protocol = state.options.protocol\n    }\n\n    // HTTP server - kill socket and switch to the fallback mode\n    if (!protocol || protocol === 'http/1.1' || protocol === 'http/1.0') {\n      debug('activating fallback')\n      socket.destroy()\n      state.fallback = true\n      return\n    }\n\n    debug('connected protocol=%j', protocol)\n    var connection = transport.connection.create(socket, Object.assign({\n      protocol: /spdy/.test(protocol) ? 'spdy' : 'http2',\n      isServer: false\n    }, state.options.connection || {}))\n\n    // Pass connection level errors are passed to the agent.\n    connection.on('error', function (err) {\n      self.emit('error', err)\n    })\n\n    // Set version when we are certain\n    if (protocol === 'h2') {\n      connection.start(4)\n    } else if (protocol === 'spdy/3.1') {\n      connection.start(3.1)\n    } else if (protocol === 'spdy/3') {\n      connection.start(3)\n    } else if (protocol === 'spdy/2') {\n      connection.start(2)\n    } else {\n      socket.destroy()\n      callback(new Error('Unexpected protocol: ' + protocol))\n      return\n    }\n\n    if (state.options['x-forwarded-for'] !== undefined) {\n      connection.sendXForwardedFor(state.options['x-forwarded-for'])\n    }\n\n    callback(null, connection)\n  })\n}\n\nproto._createSocket = function _createSocket (req, options, callback) {\n  var state = this._spdyState\n  if (state.fallback) { return state.createSocket(req, options) }\n\n  var handle = spdy.handle.create(null, null, state.socket)\n\n  var socketOptions = {\n    handle: handle,\n    allowHalfOpen: true\n  }\n\n  var socket\n  if (state.secure) {\n    socket = new spdy.Socket(state.socket, socketOptions)\n  } else {\n    socket = new net.Socket(socketOptions)\n  }\n\n  handle.assignSocket(socket)\n  handle.assignClientRequest(req)\n\n  // Create stream only once `req.end()` is called\n  var self = this\n  handle.once('needStream', function () {\n    if (state.connection === null) {\n      self.once('_connect', function () {\n        handle.setStream(self._createStream(req, handle))\n      })\n    } else {\n      handle.setStream(self._createStream(req, handle))\n    }\n  })\n\n  // Yes, it is in reverse\n  req.on('response', function (res) {\n    handle.assignRequest(res)\n  })\n  handle.assignResponse(req)\n\n  // Handle PUSH\n  req.addListener('newListener', spdy.request.onNewListener)\n\n  // For v0.8\n  socket.readable = true\n  socket.writable = true\n\n  if (callback) {\n    return callback(null, socket)\n  }\n\n  return socket\n}\n\nif (mode === 'modern' || mode === 'normal') {\n  proto.createSocket = proto._createSocket\n} else {\n  proto.createSocket = function createSocket (name, host, port, addr, req) {\n    var state = this._spdyState\n    if (state.fallback) {\n      return state.createSocket(name, host, port, addr, req)\n    }\n\n    return this._createSocket(req, {\n      host: host,\n      port: port\n    })\n  }\n}\n\nproto._createStream = function _createStream (req, handle) {\n  var state = this._spdyState\n\n  var self = this\n  return state.connection.reserveStream({\n    method: req.method,\n    path: req.path,\n    headers: req._headers,\n    host: state.host\n  }, function (err, stream) {\n    if (err) {\n      return self.emit('error', err)\n    }\n\n    stream.on('response', function (status, headers) {\n      handle.emitResponse(status, headers)\n    })\n  })\n}\n\n// Public APIs\n\nproto.close = function close (callback) {\n  var state = this._spdyState\n\n  if (state.connection === null) {\n    this.once('_connect', function () {\n      this.close(callback)\n    })\n    return\n  }\n\n  state.connection.end(callback)\n}\n\nexports.Agent = instantiate(https.Agent)\nexports.PlainAgent = instantiate(http.Agent)\n\nexports.create = function create (base, options) {\n  if (typeof base === 'object') {\n    options = base\n    base = null\n  }\n\n  if (base) {\n    return instantiate(base).create(options)\n  }\n\n  if (options.spdy && options.spdy.plain) {\n    return exports.PlainAgent.create(options)\n  } else { return exports.Agent.create(options) }\n}\n"]},"metadata":{},"sourceType":"script"}